<html>
<link rel="apple-touch-icon" sizes="120x120" href="https://github.com/rououtliner/rououtliner.github.io/blob/master/RouOutliner.png?raw=true">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
    <title>RouOutliner</title>
    <script type="text/javascript">

// for markdown
(function(){function a(a){"use strict";var b={omitExtraWLInCodeBlocks:{defaultValue:!1,describe:"Omit the default extra whiteline added to code blocks",type:"boolean"},noHeaderId:{defaultValue:!1,describe:"Turn on/off generated header id",type:"boolean"},prefixHeaderId:{defaultValue:!1,describe:"Specify a prefix to generated header ids",type:"string"},headerLevelStart:{defaultValue:!1,describe:"The header blocks level start",type:"integer"},parseImgDimensions:{defaultValue:!1,describe:"Turn on/off image dimension parsing",type:"boolean"},simplifiedAutoLink:{defaultValue:!1,describe:"Turn on/off GFM autolink style",type:"boolean"},literalMidWordUnderscores:{defaultValue:!1,describe:"Parse midword underscores as literal underscores",type:"boolean"},strikethrough:{defaultValue:!1,describe:"Turn on/off strikethrough support",type:"boolean"},tables:{defaultValue:!1,describe:"Turn on/off tables support",type:"boolean"},tablesHeaderId:{defaultValue:!1,describe:"Add an id to table headers",type:"boolean"},ghCodeBlocks:{defaultValue:!0,describe:"Turn on/off GFM fenced code blocks support",type:"boolean"},tasklists:{defaultValue:!1,describe:"Turn on/off GFM tasklist support",type:"boolean"},smoothLivePreview:{defaultValue:!1,describe:"Prevents weird effects in live previews due to incomplete input",type:"boolean"},smartIndentationFix:{defaultValue:!1,description:"Tries to smartly fix indentation in es6 strings",type:"boolean"},disableForced4SpacesIndentedSublists:{defaultValue:!1,description:"Disables the requirement of indenting nested sublists by 4 spaces",type:"boolean"}};if(a===!1)return JSON.parse(JSON.stringify(b));var c={};for(var d in b)b.hasOwnProperty(d)&&(c[d]=b[d].defaultValue);return c}function b(a,b){"use strict";var c=b?"Error in "+b+" extension->":"Error in unnamed extension",e={valid:!0,error:""};d.helper.isArray(a)||(a=[a]);for(var f=0;f<a.length;++f){var g=c+" sub-extension "+f+": ",h=a[f];if("object"!=typeof h)return e.valid=!1,e.error=g+"must be an object, but "+typeof h+" given",e;if(!d.helper.isString(h.type))return e.valid=!1,e.error=g+'property "type" must be a string, but '+typeof h.type+" given",e;var i=h.type=h.type.toLowerCase();if("language"===i&&(i=h.type="lang"),"html"===i&&(i=h.type="output"),"lang"!==i&&"output"!==i&&"listener"!==i)return e.valid=!1,e.error=g+"type "+i+' is not recognized. Valid values: "lang/language", "output/html" or "listener"',e;if("listener"===i){if(d.helper.isUndefined(h.listeners))return e.valid=!1,e.error=g+'. Extensions of type "listener" must have a property called "listeners"',e}else if(d.helper.isUndefined(h.filter)&&d.helper.isUndefined(h.regex))return e.valid=!1,e.error=g+i+' extensions must define either a "regex" property or a "filter" method',e;if(h.listeners){if("object"!=typeof h.listeners)return e.valid=!1,e.error=g+'"listeners" property must be an object but '+typeof h.listeners+" given",e;for(var j in h.listeners)if(h.listeners.hasOwnProperty(j)&&"function"!=typeof h.listeners[j])return e.valid=!1,e.error=g+'"listeners" property must be an hash of [event name]: [callback]. listeners.'+j+" must be a function but "+typeof h.listeners[j]+" given",e}if(h.filter){if("function"!=typeof h.filter)return e.valid=!1,e.error=g+'"filter" must be a function, but '+typeof h.filter+" given",e}else if(h.regex){if(d.helper.isString(h.regex)&&(h.regex=new RegExp(h.regex,"g")),!h.regex instanceof RegExp)return e.valid=!1,e.error=g+'"regex" property must either be a string or a RegExp object, but '+typeof h.regex+" given",e;if(d.helper.isUndefined(h.replace))return e.valid=!1,e.error=g+'"regex" extensions must implement a replace string or function',e}}return e}function c(a,b){"use strict";var c=b.charCodeAt(0);return"~E"+c+"E"}var d={},e={},f={},g=a(!0),h={github:{omitExtraWLInCodeBlocks:!0,prefixHeaderId:"user-content-",simplifiedAutoLink:!0,literalMidWordUnderscores:!0,strikethrough:!0,tables:!0,tablesHeaderId:!0,ghCodeBlocks:!0,tasklists:!0,disableForced4SpacesIndentedSublists:!0},vanilla:a(!0)};d.helper={},d.extensions={},d.setOption=function(a,b){"use strict";return g[a]=b,this},d.getOption=function(a){"use strict";return g[a]},d.getOptions=function(){"use strict";return g},d.resetOptions=function(){"use strict";g=a(!0)},d.setFlavor=function(a){"use strict";if(h.hasOwnProperty(a)){var b=h[a];for(var c in b)b.hasOwnProperty(c)&&(g[c]=b[c])}},d.getDefaultOptions=function(b){"use strict";return a(b)},d.subParser=function(a,b){"use strict";if(d.helper.isString(a)){if("undefined"==typeof b){if(e.hasOwnProperty(a))return e[a];throw Error("SubParser named "+a+" not registered!")}e[a]=b}},d.extension=function(a,c){"use strict";if(!d.helper.isString(a))throw Error("Extension 'name' must be a string");if(a=d.helper.stdExtName(a),d.helper.isUndefined(c)){if(!f.hasOwnProperty(a))throw Error("Extension named "+a+" is not registered!");return f[a]}"function"==typeof c&&(c=c()),d.helper.isArray(c)||(c=[c]);var e=b(c,a);if(!e.valid)throw Error(e.error);f[a]=c},d.getAllExtensions=function(){"use strict";return f},d.removeExtension=function(a){"use strict";delete f[a]},d.resetExtensions=function(){"use strict";f={}},d.validateExtension=function(a){"use strict";var c=b(a,null);return c.valid?!0:(console.warn(c.error),!1)},d.hasOwnProperty("helper")||(d.helper={}),d.helper.isString=function(a){"use strict";return"string"==typeof a||a instanceof String},d.helper.isFunction=function(a){"use strict";var b={};return a&&"[object Function]"===b.toString.call(a)},d.helper.forEach=function(a,b){"use strict";if("function"==typeof a.forEach)a.forEach(b);else for(var c=0;c<a.length;c++)b(a[c],c,a)},d.helper.isArray=function(a){"use strict";return a.constructor===Array},d.helper.isUndefined=function(a){"use strict";return"undefined"==typeof a},d.helper.stdExtName=function(a){"use strict";return a.replace(/[_-]||\s/g,"").toLowerCase()},d.helper.escapeCharactersCallback=c,d.helper.escapeCharacters=function(a,b,d){"use strict";var e="(["+b.replace(/([\[\]\\])/g,"\\$1")+"])";d&&(e="\\\\"+e);var f=new RegExp(e,"g");return a=a.replace(f,c)};var i=function(a,b,c,d){"use strict";var e,f,g,h,i,j=d||"",k=j.indexOf("g")>-1,l=new RegExp(b+"|"+c,"g"+j.replace(/g/g,"")),m=new RegExp(b,j.replace(/g/g,"")),n=[];do for(e=0;g=l.exec(a);)if(m.test(g[0]))e++||(f=l.lastIndex,h=f-g[0].length);else if(e&&!--e){i=g.index+g[0].length;var o={left:{start:h,end:f},match:{start:f,end:g.index},right:{start:g.index,end:i},wholeMatch:{start:h,end:i}};if(n.push(o),!k)return n}while(e&&(l.lastIndex=f));return n};d.helper.matchRecursiveRegExp=function(a,b,c,d){"use strict";for(var e=i(a,b,c,d),f=[],g=0;g<e.length;++g)f.push([a.slice(e[g].wholeMatch.start,e[g].wholeMatch.end),a.slice(e[g].match.start,e[g].match.end),a.slice(e[g].left.start,e[g].left.end),a.slice(e[g].right.start,e[g].right.end)]);return f},d.helper.replaceRecursiveRegExp=function(a,b,c,e,f){"use strict";if(!d.helper.isFunction(b)){var g=b;b=function(){return g}}var h=i(a,c,e,f),j=a,k=h.length;if(k>0){var l=[];0!==h[0].wholeMatch.start&&l.push(a.slice(0,h[0].wholeMatch.start));for(var m=0;k>m;++m)l.push(b(a.slice(h[m].wholeMatch.start,h[m].wholeMatch.end),a.slice(h[m].match.start,h[m].match.end),a.slice(h[m].left.start,h[m].left.end),a.slice(h[m].right.start,h[m].right.end))),k-1>m&&l.push(a.slice(h[m].wholeMatch.end,h[m+1].wholeMatch.start));h[k-1].wholeMatch.end<a.length&&l.push(a.slice(h[k-1].wholeMatch.end)),j=l.join("")}return j},d.helper.isUndefined(console)&&(console={warn:function(a){"use strict";alert(a)},log:function(a){"use strict";alert(a)},error:function(a){"use strict";throw a}}),d.Converter=function(a){"use strict";function c(){a=a||{};for(var b in g)g.hasOwnProperty(b)&&(l[b]=g[b]);if("object"!=typeof a)throw Error("Converter expects the passed parameter to be an object, but "+typeof a+" was passed instead.");for(var c in a)a.hasOwnProperty(c)&&(l[c]=a[c]);l.extensions&&d.helper.forEach(l.extensions,e)}function e(a,c){if(c=c||null,d.helper.isString(a)){if(a=d.helper.stdExtName(a),c=a,d.extensions[a])return console.warn("DEPRECATION WARNING: "+a+" is an old extension that uses a deprecated loading method.Please inform the developer that the extension should be updated!"),void i(d.extensions[a],a);if(d.helper.isUndefined(f[a]))throw Error('Extension "'+a+'" could not be loaded. It was either not found or is not a valid extension.');a=f[a]}"function"==typeof a&&(a=a()),d.helper.isArray(a)||(a=[a]);var e=b(a,c);if(!e.valid)throw Error(e.error);for(var g=0;g<a.length;++g){switch(a[g].type){case"lang":m.push(a[g]);break;case"output":n.push(a[g])}if(a[g].hasOwnProperty(o))for(var h in a[g].listeners)a[g].listeners.hasOwnProperty(h)&&j(h,a[g].listeners[h])}}function i(a,c){"function"==typeof a&&(a=a(new d.Converter)),d.helper.isArray(a)||(a=[a]);var e=b(a,c);if(!e.valid)throw Error(e.error);for(var f=0;f<a.length;++f)switch(a[f].type){case"lang":m.push(a[f]);break;case"output":n.push(a[f]);break;default:throw Error("Extension loader error: Type unrecognized!!!")}}function j(a,b){if(!d.helper.isString(a))throw Error("Invalid argument in converter.listen() method: name must be a string, but "+typeof a+" given");if("function"!=typeof b)throw Error("Invalid argument in converter.listen() method: callback must be a function, but "+typeof b+" given");o.hasOwnProperty(a)||(o[a]=[]),o[a].push(b)}function k(a){var b=a.match(/^\s*/)[0].length,c=new RegExp("^\\s{0,"+b+"}","gm");return a.replace(c,"")}var l={},m=[],n=[],o={};c(),this._dispatch=function(a,b,c,d){if(o.hasOwnProperty(a))for(var e=0;e<o[a].length;++e){var f=o[a][e](a,b,this,c,d);f&&"undefined"!=typeof f&&(b=f)}return b},this.listen=function(a,b){return j(a,b),this},this.makeHtml=function(a){if(!a)return a;var b={gHtmlBlocks:[],gHtmlMdBlocks:[],gHtmlSpans:[],gUrls:{},gTitles:{},gDimensions:{},gListLevel:0,hashLinkCounts:{},langExtensions:m,outputModifiers:n,converter:this,ghCodeBlocks:[]};return a=a.replace(/~/g,"~T"),a=a.replace(/\$/g,"~D"),a=a.replace(/\r\n/g,"\n"),a=a.replace(/\r/g,"\n"),l.smartIndentationFix&&(a=k(a)),a="\n\n"+a+"\n\n",a=d.subParser("detab")(a,l,b),a=d.subParser("stripBlankLines")(a,l,b),d.helper.forEach(m,function(c){a=d.subParser("runExtension")(c,a,l,b)}),a=d.subParser("hashPreCodeTags")(a,l,b),a=d.subParser("githubCodeBlocks")(a,l,b),a=d.subParser("hashHTMLBlocks")(a,l,b),a=d.subParser("hashHTMLSpans")(a,l,b),a=d.subParser("stripLinkDefinitions")(a,l,b),a=d.subParser("blockGamut")(a,l,b),a=d.subParser("unhashHTMLSpans")(a,l,b),a=d.subParser("unescapeSpecialChars")(a,l,b),a=a.replace(/~D/g,"$$"),a=a.replace(/~T/g,"~"),d.helper.forEach(n,function(c){a=d.subParser("runExtension")(c,a,l,b)}),a},this.setOption=function(a,b){l[a]=b},this.getOption=function(a){return l[a]},this.getOptions=function(){return l},this.addExtension=function(a,b){b=b||null,e(a,b)},this.useExtension=function(a){e(a)},this.setFlavor=function(a){if(h.hasOwnProperty(a)){var b=h[a];for(var c in b)b.hasOwnProperty(c)&&(l[c]=b[c])}},this.removeExtension=function(a){d.helper.isArray(a)||(a=[a]);for(var b=0;b<a.length;++b){for(var c=a[b],e=0;e<m.length;++e)m[e]===c&&m[e].splice(e,1);for(var f=0;f<n.length;++e)n[f]===c&&n[f].splice(e,1)}},this.getAllExtensions=function(){return{language:m,output:n}}},d.subParser("anchors",function(a,b,c){"use strict";a=c.converter._dispatch("anchors.before",a,b,c);var e=function(a,b,e,f,g,h,i,j){d.helper.isUndefined(j)&&(j=""),a=b;var k=e,l=f.toLowerCase(),m=g,n=j;if(!m)if(l||(l=k.toLowerCase().replace(/ ?\n/g," ")),m="#"+l,d.helper.isUndefined(c.gUrls[l])){if(!(a.search(/\(\s*\)$/m)>-1))return a;m=""}else m=c.gUrls[l],d.helper.isUndefined(c.gTitles[l])||(n=c.gTitles[l]);m=d.helper.escapeCharacters(m,"*_",!1);var o='<a href="'+m+'"';return""!==n&&null!==n&&(n=n.replace(/"/g,"&quot;"),n=d.helper.escapeCharacters(n,"*_",!1),o+=' title="'+n+'"'),o+=">"+k+"</a>"};return a=a.replace(/(\[((?:\[[^\]]*]|[^\[\]])*)][ ]?(?:\n[ ]*)?\[(.*?)])()()()()/g,e),a=a.replace(/(\[((?:\[[^\]]*]|[^\[\]])*)]\([ \t]*()<?(.*?(?:\(.*?\).*?)?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g,e),a=a.replace(/(\[([^\[\]]+)])()()()()()/g,e),a=c.converter._dispatch("anchors.after",a,b,c)}),d.subParser("autoLinks",function(a,b,c){"use strict";function e(a,b){var c=b;return/^www\./i.test(b)&&(b=b.replace(/^www\./i,"http://www.")),'<a href="'+b+'">'+c+"</a>"}function f(a,b){var c=d.subParser("unescapeSpecialChars")(b);return d.subParser("encodeEmailAddress")(c)}a=c.converter._dispatch("autoLinks.before",a,b,c);var g=/\b(((https?|ftp|dict):\/\/|www\.)[^'">\s]+\.[^'">\s]+)(?=\s|$)(?!["<>])/gi,h=/<(((https?|ftp|dict):\/\/|www\.)[^'">\s]+)>/gi,i=/(?:^|\s)([A-Za-z0-9!#$%&'*+-\/=?^_`\{|}~\.]+@[-a-z0-9]+(\.[-a-z0-9]+)*\.[a-z]+)(?:$|\s)/gi,j=/<(?:mailto:)?([-.\w]+@[-a-z0-9]+(\.[-a-z0-9]+)*\.[a-z]+)>/gi;return a=a.replace(h,e),a=a.replace(j,f),b.simplifiedAutoLink&&(a=a.replace(g,e),a=a.replace(i,f)),a=c.converter._dispatch("autoLinks.after",a,b,c)}),d.subParser("blockGamut",function(a,b,c){"use strict";a=c.converter._dispatch("blockGamut.before",a,b,c),a=d.subParser("blockQuotes")(a,b,c),a=d.subParser("headers")(a,b,c);var e=d.subParser("hashBlock")("<hr />",b,c);return a=a.replace(/^[ ]{0,2}([ ]?\*[ ]?){3,}[ \t]*$/gm,e),a=a.replace(/^[ ]{0,2}([ ]?\-[ ]?){3,}[ \t]*$/gm,e),a=a.replace(/^[ ]{0,2}([ ]?_[ ]?){3,}[ \t]*$/gm,e),a=d.subParser("lists")(a,b,c),a=d.subParser("codeBlocks")(a,b,c),a=d.subParser("tables")(a,b,c),a=d.subParser("hashHTMLBlocks")(a,b,c),a=d.subParser("paragraphs")(a,b,c),a=c.converter._dispatch("blockGamut.after",a,b,c)}),d.subParser("blockQuotes",function(a,b,c){"use strict";return a=c.converter._dispatch("blockQuotes.before",a,b,c),a=a.replace(/((^ {0,3}>[ \t]?.+\n(.+\n)*\n*)+)/gm,function(a,e){var f=e;return f=f.replace(/^[ \t]*>[ \t]?/gm,"~0"),f=f.replace(/~0/g,""),f=f.replace(/^[ \t]+$/gm,""),f=d.subParser("githubCodeBlocks")(f,b,c),f=d.subParser("blockGamut")(f,b,c),f=f.replace(/(^|\n)/g,"$1  "),f=f.replace(/(\s*<pre>[^\r]+?<\/pre>)/gm,function(a,b){var c=b;return c=c.replace(/^  /gm,"~0"),c=c.replace(/~0/g,"")}),d.subParser("hashBlock")("<blockquote>\n"+f+"\n</blockquote>",b,c)}),a=c.converter._dispatch("blockQuotes.after",a,b,c)}),d.subParser("codeBlocks",function(a,b,c){"use strict";a=c.converter._dispatch("codeBlocks.before",a,b,c),a+="~0";var e=/(?:\n\n|^)((?:(?:[ ]{4}|\t).*\n+)+)(\n*[ ]{0,3}[^ \t\n]|(?=~0))/g;return a=a.replace(e,function(a,e,f){var g=e,h=f,i="\n";return g=d.subParser("outdent")(g),g=d.subParser("encodeCode")(g),g=d.subParser("detab")(g),g=g.replace(/^\n+/g,""),g=g.replace(/\n+$/g,""),b.omitExtraWLInCodeBlocks&&(i=""),g="<pre><code>"+g+i+"</code></pre>",d.subParser("hashBlock")(g,b,c)+h}),a=a.replace(/~0/,""),a=c.converter._dispatch("codeBlocks.after",a,b,c)}),d.subParser("codeSpans",function(a,b,c){"use strict";return a=c.converter._dispatch("codeSpans.before",a,b,c),"undefined"==typeof a&&(a=""),a=a.replace(/(^|[^\\])(`+)([^\r]*?[^`])\2(?!`)/gm,function(a,b,c,e){var f=e;return f=f.replace(/^([ \t]*)/g,""),f=f.replace(/[ \t]*$/g,""),f=d.subParser("encodeCode")(f),b+"<code>"+f+"</code>"}),a=c.converter._dispatch("codeSpans.after",a,b,c)}),d.subParser("detab",function(a){"use strict";return a=a.replace(/\t(?=\t)/g,"    "),a=a.replace(/\t/g,"~A~B"),a=a.replace(/~B(.+?)~A/g,function(a,b){for(var c=b,d=4-c.length%4,e=0;d>e;e++)c+=" ";return c}),a=a.replace(/~A/g,"    "),a=a.replace(/~B/g,"")}),d.subParser("encodeAmpsAndAngles",function(a){"use strict";return a=a.replace(/&(?!#?[xX]?(?:[0-9a-fA-F]+|\w+);)/g,"&amp;"),a=a.replace(/<(?![a-z\/?\$!])/gi,"&lt;")}),d.subParser("encodeBackslashEscapes",function(a){"use strict";return a=a.replace(/\\(\\)/g,d.helper.escapeCharactersCallback),a=a.replace(/\\([`*_{}\[\]()>#+-.!])/g,d.helper.escapeCharactersCallback)}),d.subParser("encodeCode",function(a){"use strict";return a=a.replace(/&/g,"&amp;"),a=a.replace(/</g,"&lt;"),a=a.replace(/>/g,"&gt;"),a=d.helper.escapeCharacters(a,"*_{}[]\\",!1)}),d.subParser("encodeEmailAddress",function(a){"use strict";var b=[function(a){return"&#"+a.charCodeAt(0)+";"},function(a){return"&#x"+a.charCodeAt(0).toString(16)+";"},function(a){return a}];return a="mailto:"+a,a=a.replace(/./g,function(a){if("@"===a)a=b[Math.floor(2*Math.random())](a);else if(":"!==a){var c=Math.random();a=c>.9?b[2](a):c>.45?b[1](a):b[0](a)}return a}),a='<a href="'+a+'">'+a+"</a>",a=a.replace(/">.+:/g,'">')}),d.subParser("escapeSpecialCharsWithinTagAttributes",function(a){"use strict";var b=/(<[a-z\/!$]("[^"]*"|'[^']*'|[^'">])*>|<!(--.*?--\s*)+>)/gi;return a=a.replace(b,function(a){var b=a.replace(/(.)<\/?code>(?=.)/g,"$1`");return b=d.helper.escapeCharacters(b,"\\`*_",!1)})}),d.subParser("githubCodeBlocks",function(a,b,c){"use strict";return b.ghCodeBlocks?(a=c.converter._dispatch("githubCodeBlocks.before",a,b,c),a+="~0",a=a.replace(/(?:^|\n)```(.*)\n([\s\S]*?)\n```/g,function(a,e,f){var g=b.omitExtraWLInCodeBlocks?"":"\n";return f=d.subParser("encodeCode")(f),f=d.subParser("detab")(f),f=f.replace(/^\n+/g,""),f=f.replace(/\n+$/g,""),f="<pre><code"+(e?' class="'+e+" language-"+e+'"':"")+">"+f+g+"</code></pre>",f=d.subParser("hashBlock")(f,b,c),"\n\n~G"+(c.ghCodeBlocks.push({text:a,codeblock:f})-1)+"G\n\n"}),a=a.replace(/~0/,""),c.converter._dispatch("githubCodeBlocks.after",a,b,c)):a}),d.subParser("hashBlock",function(a,b,c){"use strict";return a=a.replace(/(^\n+|\n+$)/g,""),"\n\n~K"+(c.gHtmlBlocks.push(a)-1)+"K\n\n"}),d.subParser("hashElement",function(a,b,c){"use strict";return function(a,b){var d=b;return d=d.replace(/\n\n/g,"\n"),d=d.replace(/^\n/,""),d=d.replace(/\n+$/g,""),d="\n\n~K"+(c.gHtmlBlocks.push(d)-1)+"K\n\n"}}),d.subParser("hashHTMLBlocks",function(a,b,c){"use strict";for(var e=["pre","div","h1","h2","h3","h4","h5","h6","blockquote","table","dl","ol","ul","script","noscript","form","fieldset","iframe","math","style","section","header","footer","nav","article","aside","address","audio","canvas","figure","hgroup","output","video","p"],f=function(a,b,d,e){var f=a;return-1!==d.search(/\bmarkdown\b/)&&(f=d+c.converter.makeHtml(b)+e),"\n\n~K"+(c.gHtmlBlocks.push(f)-1)+"K\n\n"},g=0;g<e.length;++g)a=d.helper.replaceRecursiveRegExp(a,f,"^ {0,3}<"+e[g]+"\\b[^>]*>","</"+e[g]+">","gim");return a=a.replace(/(\n {0,3}(<(hr)\b([^<>])*?\/?>)[ \t]*(?=\n{2,}))/g,d.subParser("hashElement")(a,b,c)),a=d.helper.replaceRecursiveRegExp(a,function(a){return"\n\n~K"+(c.gHtmlBlocks.push(a)-1)+"K\n\n"},"^ {0,3}<!--","-->","gm"),a=a.replace(/(?:\n\n)( {0,3}(?:<([?%])[^\r]*?\2>)[ \t]*(?=\n{2,}))/g,d.subParser("hashElement")(a,b,c))}),d.subParser("hashHTMLSpans",function(a,b,c){"use strict";for(var e=d.helper.matchRecursiveRegExp(a,"<code\\b[^>]*>","</code>","gi"),f=0;f<e.length;++f)a=a.replace(e[f][0],"~L"+(c.gHtmlSpans.push(e[f][0])-1)+"L");return a}),d.subParser("unhashHTMLSpans",function(a,b,c){"use strict";for(var d=0;d<c.gHtmlSpans.length;++d)a=a.replace("~L"+d+"L",c.gHtmlSpans[d]);return a}),d.subParser("hashPreCodeTags",function(a,b,c){"use strict";var e=function(a,b,e,f){var g=e+d.subParser("encodeCode")(b)+f;return"\n\n~G"+(c.ghCodeBlocks.push({text:a,codeblock:g})-1)+"G\n\n"};return a=d.helper.replaceRecursiveRegExp(a,e,"^ {0,3}<pre\\b[^>]*>\\s*<code\\b[^>]*>","^ {0,3}</code>\\s*</pre>","gim")}),d.subParser("headers",function(a,b,c){"use strict";function e(a){var b,e=a.replace(/[^\w]/g,"").toLowerCase();return c.hashLinkCounts[e]?b=e+"-"+c.hashLinkCounts[e]++:(b=e,c.hashLinkCounts[e]=1),f===!0&&(f="section"),d.helper.isString(f)?f+b:b}a=c.converter._dispatch("headers.before",a,b,c);var f=b.prefixHeaderId,g=isNaN(parseInt(b.headerLevelStart))?1:parseInt(b.headerLevelStart),h=b.smoothLivePreview?/^(.+)[ \t]*\n={2,}[ \t]*\n+/gm:/^(.+)[ \t]*\n=+[ \t]*\n+/gm,i=b.smoothLivePreview?/^(.+)[ \t]*\n-{2,}[ \t]*\n+/gm:/^(.+)[ \t]*\n-+[ \t]*\n+/gm;return a=a.replace(h,function(a,f){var h=d.subParser("spanGamut")(f,b,c),i=b.noHeaderId?"":' id="'+e(f)+'"',j=g,k="<h"+j+i+">"+h+"</h"+j+">";return d.subParser("hashBlock")(k,b,c)}),a=a.replace(i,function(a,f){var h=d.subParser("spanGamut")(f,b,c),i=b.noHeaderId?"":' id="'+e(f)+'"',j=g+1,k="<h"+j+i+">"+h+"</h"+j+">";return d.subParser("hashBlock")(k,b,c)}),a=a.replace(/^(#{1,6})[ \t]*(.+?)[ \t]*#*\n+/gm,function(a,f,h){var i=d.subParser("spanGamut")(h,b,c),j=b.noHeaderId?"":' id="'+e(h)+'"',k=g-1+f.length,l="<h"+k+j+">"+i+"</h"+k+">";return d.subParser("hashBlock")(l,b,c)}),a=c.converter._dispatch("headers.after",a,b,c)}),d.subParser("images",function(a,b,c){"use strict";function e(a,b,e,f,g,h,i,j){var k=c.gUrls,l=c.gTitles,m=c.gDimensions;if(e=e.toLowerCase(),j||(j=""),""===f||null===f){if((""===e||null===e)&&(e=b.toLowerCase().replace(/ ?\n/g," ")),f="#"+e,d.helper.isUndefined(k[e]))return a;f=k[e],d.helper.isUndefined(l[e])||(j=l[e]),d.helper.isUndefined(m[e])||(g=m[e].width,h=m[e].height)}b=b.replace(/"/g,"&quot;"),b=d.helper.escapeCharacters(b,"*_",!1),f=d.helper.escapeCharacters(f,"*_",!1);var n='<img src="'+f+'" alt="'+b+'"';return j&&(j=j.replace(/"/g,"&quot;"),j=d.helper.escapeCharacters(j,"*_",!1),n+=' title="'+j+'"'),g&&h&&(g="*"===g?"auto":g,h="*"===h?"auto":h,n+=' width="'+g+'"',n+=' height="'+h+'"'),n+=" />"}a=c.converter._dispatch("images.before",a,b,c);var f=/!\[(.*?)]\s?\([ \t]*()<?(\S+?)>?(?: =([*\d]+[A-Za-z%]{0,4})x([*\d]+[A-Za-z%]{0,4}))?[ \t]*(?:(['"])(.*?)\6[ \t]*)?\)/g,g=/!\[([^\]]*?)] ?(?:\n *)?\[(.*?)]()()()()()/g;return a=a.replace(g,e),a=a.replace(f,e),a=c.converter._dispatch("images.after",a,b,c)}),d.subParser("italicsAndBold",function(a,b,c){"use strict";return a=c.converter._dispatch("italicsAndBold.before",a,b,c),b.literalMidWordUnderscores?(a=a.replace(/(^|\s|>|\b)__(?=\S)([\s\S]+?)__(?=\b|<|\s|$)/gm,"$1<strong>$2</strong>"),a=a.replace(/(^|\s|>|\b)_(?=\S)([\s\S]+?)_(?=\b|<|\s|$)/gm,"$1<em>$2</em>"),a=a.replace(/(\*\*)(?=\S)([^\r]*?\S[*]*)\1/g,"<strong>$2</strong>"),a=a.replace(/(\*)(?=\S)([^\r]*?\S)\1/g,"<em>$2</em>")):(a=a.replace(/(\*\*|__)(?=\S)([^\r]*?\S[*_]*)\1/g,"<strong>$2</strong>"),a=a.replace(/(\*|_)(?=\S)([^\r]*?\S)\1/g,"<em>$2</em>")),a=c.converter._dispatch("italicsAndBold.after",a,b,c)}),d.subParser("lists",function(a,b,c){"use strict";function e(a,e){c.gListLevel++,a=a.replace(/\n{2,}$/,"\n"),a+="~0";var f=/(\n)?(^ {0,3})([*+-]|\d+[.])[ \t]+((\[(x|X| )?])?[ \t]*[^\r]+?(\n{1,2}))(?=\n*(~0| {0,3}([*+-]|\d+[.])[ \t]+))/gm,g=/\n[ \t]*\n(?!~0)/.test(a);return b.disableForced4SpacesIndentedSublists&&(f=/(\n)?(^ {0,3})([*+-]|\d+[.])[ \t]+((\[(x|X| )?])?[ \t]*[^\r]+?(\n{1,2}))(?=\n*(~0|\2([*+-]|\d+[.])[ \t]+))/gm),a=a.replace(f,function(a,e,f,h,i,j,k){k=k&&""!==k.trim();var l=d.subParser("outdent")(i,b,c),m="";return j&&b.tasklists&&(m=' class="task-list-item" style="list-style-type: none;"',l=l.replace(/^[ \t]*\[(x|X| )?]/m,function(){var a='<input type="checkbox" disabled style="margin: 0px 0.35em 0.25em -1.6em; vertical-align: middle;"';return k&&(a+=" checked"),a+=">"})),e||l.search(/\n{2,}/)>-1?(l=d.subParser("githubCodeBlocks")(l,b,c),l=d.subParser("blockGamut")(l,b,c)):(l=d.subParser("lists")(l,b,c),l=l.replace(/\n$/,""),l=g?d.subParser("paragraphs")(l,b,c):d.subParser("spanGamut")(l,b,c)),l="<li"+m+">"+l+"</li>\n"}),a=a.replace(/~0/g,""),c.gListLevel--,e&&(a=a.replace(/\s+$/,"")),a}function f(a,c,d){var f=b.disableForced4SpacesIndentedSublists?/^ ?\d+\.[ \t]/gm:/^ {0,3}\d+\.[ \t]/gm,g=b.disableForced4SpacesIndentedSublists?/^ ?[*+-][ \t]/gm:/^ {0,3}[*+-][ \t]/gm,h="ul"===c?f:g,i="";return-1!==a.search(h)?!function j(a){var b=a.search(h);-1!==b?(i+="\n<"+c+">\n"+e(a.slice(0,b),!!d)+"</"+c+">\n",c="ul"===c?"ol":"ul",h="ul"===c?f:g,j(a.slice(b))):i+="\n<"+c+">\n"+e(a,!!d)+"</"+c+">\n"}(a):i="\n<"+c+">\n"+e(a,!!d)+"</"+c+">\n",i}return a=c.converter._dispatch("lists.before",a,b,c),a+="~0",a=c.gListLevel?a.replace(/^(( {0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/gm,function(a,b,c){var d=c.search(/[*+-]/g)>-1?"ul":"ol";return f(b,d,!0)}):a.replace(/(\n\n|^\n?)(( {0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/gm,function(a,b,c,d){var e=d.search(/[*+-]/g)>-1?"ul":"ol";return f(c,e,!1)}),a=a.replace(/~0/,""),a=c.converter._dispatch("lists.after",a,b,c)}),d.subParser("outdent",function(a){"use strict";return a=a.replace(/^(\t|[ ]{1,4})/gm,"~0"),a=a.replace(/~0/g,"")}),d.subParser("paragraphs",function(a,b,c){"use strict";a=c.converter._dispatch("paragraphs.before",a,b,c),a=a.replace(/^\n+/g,""),a=a.replace(/\n+$/g,"");for(var e=a.split(/\n{2,}/g),f=[],g=e.length,h=0;g>h;h++){var i=e[h];i.search(/~(K|G)(\d+)\1/g)>=0?f.push(i):(i=d.subParser("spanGamut")(i,b,c),i=i.replace(/^([ \t]*)/g,"<p>"),i+="</p>",f.push(i))}for(g=f.length,h=0;g>h;h++){for(var j="",k=f[h],l=!1;k.search(/~(K|G)(\d+)\1/)>=0;){var m=RegExp.$1,n=RegExp.$2;j="K"===m?c.gHtmlBlocks[n]:l?d.subParser("encodeCode")(c.ghCodeBlocks[n].text):c.ghCodeBlocks[n].codeblock,j=j.replace(/\$/g,"$$$$"),k=k.replace(/(\n\n)?~(K|G)\d+\2(\n\n)?/,j),/^<pre\b[^>]*>\s*<code\b[^>]*>/.test(k)&&(l=!0)}f[h]=k}return a=f.join("\n"),a=a.replace(/^\n+/g,""),a=a.replace(/\n+$/g,""),c.converter._dispatch("paragraphs.after",a,b,c)}),d.subParser("runExtension",function(a,b,c,d){"use strict";if(a.filter)b=a.filter(b,d.converter,c);else if(a.regex){var e=a.regex;!e instanceof RegExp&&(e=new RegExp(e,"g")),b=b.replace(e,a.replace)}return b}),d.subParser("spanGamut",function(a,b,c){"use strict";return a=c.converter._dispatch("spanGamut.before",a,b,c),a=d.subParser("codeSpans")(a,b,c),a=d.subParser("escapeSpecialCharsWithinTagAttributes")(a,b,c),a=d.subParser("encodeBackslashEscapes")(a,b,c),a=d.subParser("images")(a,b,c),a=d.subParser("anchors")(a,b,c),a=d.subParser("autoLinks")(a,b,c),a=d.subParser("encodeAmpsAndAngles")(a,b,c),a=d.subParser("italicsAndBold")(a,b,c),a=d.subParser("strikethrough")(a,b,c),a=a.replace(/  +\n/g," <br />\n"),a=c.converter._dispatch("spanGamut.after",a,b,c)}),d.subParser("strikethrough",function(a,b,c){"use strict";return b.strikethrough&&(a=c.converter._dispatch("strikethrough.before",a,b,c),a=a.replace(/(?:~T){2}([\s\S]+?)(?:~T){2}/g,"<del>$1</del>"),a=c.converter._dispatch("strikethrough.after",a,b,c)),a}),d.subParser("stripBlankLines",function(a){"use strict";return a.replace(/^[ \t]+$/gm,"")}),d.subParser("stripLinkDefinitions",function(a,b,c){"use strict";var e=/^ {0,3}\[(.+)]:[ \t]*\n?[ \t]*<?(\S+?)>?(?: =([*\d]+[A-Za-z%]{0,4})x([*\d]+[A-Za-z%]{0,4}))?[ \t]*\n?[ \t]*(?:(\n*)["|'(](.+?)["|')][ \t]*)?(?:\n+|(?=~0))/gm;return a+="~0",a=a.replace(e,function(a,e,f,g,h,i,j){return e=e.toLowerCase(),c.gUrls[e]=d.subParser("encodeAmpsAndAngles")(f),i?i+j:(j&&(c.gTitles[e]=j.replace(/"|'/g,"&quot;")),b.parseImgDimensions&&g&&h&&(c.gDimensions[e]={width:g,height:h}),"")}),a=a.replace(/~0/,"")}),d.subParser("tables",function(a,b,c){"use strict";function e(a){return/^:[ \t]*--*$/.test(a)?' style="text-align:left;"':/^--*[ \t]*:[ \t]*$/.test(a)?' style="text-align:right;"':/^:[ \t]*--*[ \t]*:$/.test(a)?' style="text-align:center;"':""}function f(a,e){var f="";return a=a.trim(),b.tableHeaderId&&(f=' id="'+a.replace(/ /g,"_").toLowerCase()+'"'),a=d.subParser("spanGamut")(a,b,c),"<th"+f+e+">"+a+"</th>\n"}function g(a,e){var f=d.subParser("spanGamut")(a,b,c);return"<td"+e+">"+f+"</td>\n"}function h(a,b){for(var c="<table>\n<thead>\n<tr>\n",d=a.length,e=0;d>e;++e)c+=a[e];for(c+="</tr>\n</thead>\n<tbody>\n",e=0;e<b.length;++e){c+="<tr>\n";for(var f=0;d>f;++f)c+=b[e][f];c+="</tr>\n"}return c+="</tbody>\n</table>\n"}if(!b.tables)return a;var i=/^ {0,3}\|?.+\|.+\n[ \t]{0,3}\|?[ \t]*:?[ \t]*(?:-|=){2,}[ \t]*:?[ \t]*\|[ \t]*:?[ \t]*(?:-|=){2,}[\s\S]+?(?:\n\n|~0)/gm;return a=c.converter._dispatch("tables.before",a,b,c),a=a.replace(i,function(a){var b,c=a.split("\n");for(b=0;b<c.length;++b)/^ {0,3}\|/.test(c[b])&&(c[b]=c[b].replace(/^ {0,3}\|/,"")),/\|[ \t]*$/.test(c[b])&&(c[b]=c[b].replace(/\|[ \t]*$/,""));var i=c[0].split("|").map(function(a){return a.trim()}),j=c[1].split("|").map(function(a){return a.trim()}),k=[],l=[],m=[],n=[];for(c.shift(),c.shift(),b=0;b<c.length;++b)""!==c[b].trim()&&k.push(c[b].split("|").map(function(a){return a.trim()}));if(i.length<j.length)return a;for(b=0;b<j.length;++b)m.push(e(j[b]));for(b=0;b<i.length;++b)d.helper.isUndefined(m[b])&&(m[b]=""),l.push(f(i[b],m[b]));for(b=0;b<k.length;++b){for(var o=[],p=0;p<l.length;++p)d.helper.isUndefined(k[b][p]),o.push(g(k[b][p],m[p]));n.push(o)}return h(l,n)}),a=c.converter._dispatch("tables.after",a,b,c)}),d.subParser("unescapeSpecialChars",function(a){"use strict";return a=a.replace(/~E(\d+)E/g,function(a,b){var c=parseInt(b);return String.fromCharCode(c)})});var j=this;"undefined"!=typeof module&&module.exports?module.exports=d:"function"==typeof define&&define.amd?define(function(){"use strict";return d}):j.showdown=d}).call(this);
    
var wd = "# RouOutliner  \n\n";
wd = wd + "Simplicity is the best.  \n";
wd = wd + "RouOutliner, a plain text outliner with only three features.  \n";
wd = wd + "Outliner, Table and Checklist.  \n";
wd = wd + "To Organize, to Clarify and to Action.  \n";
wd = wd + "\n";
wd = wd + "---\n";
wd = wd + "\n";
wd = wd + "* Why create this outliner?\n";
wd = wd + "    * I (@Roulesophy) am a Drafts4 and OmniOutliner heavy user in iOS.\n";
wd = wd + "    * I created some script in Drafts4's for outlining\n";
wd = wd + "    * Sometimes I am not using iPad I also need to do outlining\n";
wd = wd + "    * I really missed those functions I developed!\n";
wd = wd + "    * Therefore, RouOutliner is out :)\n";
wd = wd + "* Why plain text?\n";
wd = wd + "    * Plain text is the content which can stay for longest time\n";
wd = wd + "        * Needs specific program to open proprietary format\n";
wd = wd + "        * What if we cannot use them?\n";
wd = wd + "    * It is better to do version control\n";
wd = wd + "* How to use this outliner? (Ctrl-/ for more info)\n";
wd = wd + "    * Organising your idea:\n";
wd = wd + "        * Type all random thinkings in your mind here\n";
wd = wd + "        * Use our indend function to make hierarcy\n";
wd = wd + "            * Try Ctrl-H and Ctrl L here!\n";
wd = wd + "        * Use our reordering function to create sequence\n";
wd = wd + "            * Important thing comes first\n";
wd = wd + "            * Try Ctrl-J and Ctrl K here!\n";
wd = wd + "    * Convert the idea to action\n";
wd = wd + "        * Insert todo for points needed\n";
wd = wd + "        * Try Ctrl-O here! Press at least 5 times ;)\n";
wd = wd + "    * Use table to make your idea clear\n";
wd = wd + "        * Press Ctrl-\ to add column\n";
wd = wd + "        * It is hard to read the table format like the following\n";
wd = wd + "        * Try Ctrl-; here! It will format the table ;)\n";
wd = wd + "\n";
wd = wd + "\n";
wd = wd + " |  | Plain Text | proprietary format | \n";
wd = wd + " | --- | --- | --- | \n";
wd = wd + " | Outliner | RouOutliner | OmniOutliner | \n";
wd = wd + " | Text Editor | Vim | TextEdit | \n";

var tutorial = "";
tutorial = tutorial + "# Help file  \n";
tutorial = tutorial + "    \n";
tutorial = tutorial + "   Key                 | Feature                        \n";
tutorial = tutorial + "   ---                 | ---                            \n";
tutorial = tutorial + "* Outlining\n";
tutorial = tutorial + "    * Ctrl H           | Outdent a block                \n";
tutorial = tutorial + "    * Ctrl L           | Indent a block                 \n";
tutorial = tutorial + "    * Ctrl J           | Move down a block              \n";
tutorial = tutorial + "    * Ctrl K           | Move up a block                \n";
tutorial = tutorial + "    * Ctrl Shift H     | Move left a line               \n";
tutorial = tutorial + "    * Ctrl Shift L     | Move right a line              \n";
tutorial = tutorial + "    * Ctrl Shift J     | Move down a line               \n";
tutorial = tutorial + "    * Ctrl Shift K     | Move up a line                 \n";
tutorial = tutorial + "    * Ctrl D           | Delete                         \n";
tutorial = tutorial + "    * Ctrl E           | Empty line content             \n";
tutorial = tutorial + "    * Ctrl '           | Toggle comment                 \n";
tutorial = tutorial + "    * Ctrl R           | Find and replace               \n";
tutorial = tutorial + "    * Enter            | Enter next point               \n";
tutorial = tutorial + "    * Ctrl Enter       | Enter next sub point           \n";
tutorial = tutorial + "    * Ctrl Shift Enter | Enter point before             \n";
tutorial = tutorial + "* Todo List\n";
tutorial = tutorial + "    * Ctrl O           | Insert todo, toggle finish todo\n";
tutorial = tutorial + "    * Ctrl ]           | Toggle todo status             \n";
tutorial = tutorial + "    * Ctrl [           | Toggle todo status reverse     \n";
tutorial = tutorial + "* Table\n";
tutorial = tutorial + "    * Ctrl \           | Insert table column            \n";
tutorial = tutorial + "    * Ctrl ;           | Format table                   \n";
tutorial = tutorial + "* Markdown editing\n";
tutorial = tutorial + "    * Ctrl B           | Bold                           \n";
tutorial = tutorial + "    * Ctrl I           | Italic                         \n";
tutorial = tutorial + "    * Ctrl U           | Insert URL                     \n";
tutorial = tutorial + "    * Ctrl P           | Insert picture                 \n";
tutorial = tutorial + "* View\n";
tutorial = tutorial + "    * Ctrl =           | Increase font size             \n";
tutorial = tutorial + "    * Ctrl -           | Decrease font size             \n";
tutorial = tutorial + "    * Ctrl M           | Markdown preview               \n";
tutorial = tutorial + "* Navigation\n";
tutorial = tutorial + "    * Ctrl Shift 0-9   | Go to file 0-9                 \n";
tutorial = tutorial + "    * Ctrl Shift /     | Go to manual page              \n";
tutorial = tutorial + "    * Ctrl Shift ,     | Go to Index                    \n";
tutorial = tutorial + "    * Ctrl Shift .     | Go to homepage                 \n";
tutorial = tutorial + "\n";
tutorial = tutorial + "Now press Ctrl Shift <number> to your file...";

var markdownConverter = new showdown.Converter();
markdownConverter.setOption('strikethrough', 'true');
markdownConverter.setOption('parseImgDimensions', 'true');
markdownConverter.setOption('literalMidWordUnderscores', 'true');
markdownConverter.setOption('tables', 'true');
markdownConverter.setOption('tasklists', 'true');

var fontSize = 14;
var mdCursor = 0;

var maxCallCount = 999999;
var reg1 = '1';
var reg2 = '2';
var reg3 = '3';
var reg4 = '4';
var reg5 = '5';
var reg6 = '6';
var reg7 = '7';
var reg8 = '8';
var reg9 = '9';
var reg0 = '0';
var regTut = '?';
var regHome = '#';
var regIndex = '!';
var regTodo = '`';


var currentReg = reg1;

var textarea;
var markdown;
var localStorageKey = 'content';
window.onload = init;

// ------------------------------------------
// Rou Writer specific function

function init()
{
    textarea = document.getElementById("textarea");
    markdown = document.getElementById("markdown");
    
    markdown.style.display = 'none';
    textarea.style.display = '';

	displayFontSize();

    getRegContent();
    
    document.addEventListener("keydown", function(e)
    {
		e = e || window.event;
		var key = e.which || e.keyCode; // keyCode detection
		var ctrl = e.ctrlKey ? e.ctrlKey : ((key === 17) ? true : false); // ctrl detection
		var alt = e.altKey ? e.altKey : ((key === 18) ? true : false); // alt detection
		var shift = e.shiftKey ? e.shiftKey : ((key === 16) ? true : false); // alt detection
		if (key == 77 && ctrl) // ctrl m
		{
			e.preventDefault();
			toggleMarkdown();
		}
	},false);

    textarea.addEventListener("keydown", function(e)
    {
        e = e || window.event;
        var key = e.which || e.keyCode; // keyCode detection
        var ctrl = e.ctrlKey ? e.ctrlKey : ((key === 17) ? true : false); // ctrl detection
        var alt = e.altKey ? e.altKey : ((key === 18) ? true : false); // alt detection
        var shift = e.shiftKey ? e.shiftKey : ((key === 16) ? true : false); // alt detection
        if (key == 72 && ctrl && shift) // ctrl shift h
        {
            e.preventDefault();
            moveLeft();
        }
        else if (key == 76 && ctrl && shift) // ctrl shift l
        {
            e.preventDefault();
            moveRight();
        }
        else if (key == 72 && ctrl) // ctrl h
        {
            e.preventDefault();
            pushLeftBlock();
        }
        else if (key == 74 && ctrl && shift) // ctrl shift j
        {
            e.preventDefault();
            moveDown();
        }
        else if (key == 75 && ctrl && shift) // ctrl shift k
        {
            e.preventDefault();
            moveUp();
        }
        else if (key == 74 && ctrl) // ctrl j
        {
            e.preventDefault();
            pushDownBlock();
        }
        else if (key == 75 && ctrl) // ctrl k
        {
            e.preventDefault();
            pushUpBlock();
        }
        else if (key == 76 && ctrl) // ctrl l
        {
            e.preventDefault();
            pushRightBlock();
        }
        else if (key == 79 && ctrl && shift) // ctrl shift o
        {
            e.preventDefault();
            nonPointsTodo();
        }
        else if (key == 79 && ctrl) // ctrl o
        {
            e.preventDefault();
            handleCheckBox();
        }
        else if (key == 221 && ctrl && shift) // ctrl shift ]
        {
            e.preventDefault();
            toggleRightNonPointsCheckBox();
        }
        else if (key == 219 && ctrl && shift) // ctrl shift [
        {
            e.preventDefault();
            toggleLeftNonPointsCheckBox();
        }
        else if (key == 221 && ctrl) // ctrl ]
        {
            e.preventDefault();
            toggleRightCheckBox();
        }
        else if (key == 219 && ctrl) // ctrl [
        {
            e.preventDefault();
            toggleLeftCheckBox();
        }
        else if (key == 186 && ctrl) // ctrl ;
        {
            e.preventDefault();
            table();
        }
        else if (key == 68 && ctrl) // ctrl d
        {
            e.preventDefault();
            deleteElement();
        }
        else if (key == 222 && ctrl) // ctrl '
        {
            e.preventDefault();
            toggleComment();
        }
        else if (key == 66 && ctrl) // ctrl b
        {
            e.preventDefault();
            bold();
        }
        else if (key == 73 && ctrl) // ctrl i
        {
            e.preventDefault();
            italic();
        }
        else if (key == 85 && ctrl) // ctrl u
        {
            e.preventDefault();
            insertURL();
        }
        else if (key == 80 && ctrl) // ctrl p
        {
            e.preventDefault();
            insertPicture();
        }
        else if (key == 82 && ctrl) // ctrl r
        {
        	replace();
            e.preventDefault();
        }
        else if (key == 83 && ctrl) // ctrl s, disable save action
        {
            e.preventDefault();
        }
        else if (key == 220 && ctrl) // ctrl \
        {
        	insertTableDelimiter();
            e.preventDefault();
        }
        else if (key == 187 && ctrl) // ctrl =
        {
            e.preventDefault();
        	increaseFontSize();
        }
        else if (key == 189 && ctrl) // ctrl -
        {
            e.preventDefault();
        	decreaseFontSize();
        }
        else if (key == 69 && ctrl) // ctrl e
        {
            e.preventDefault();
            emptyLine();
        }
        else if (key == 49 && ctrl && shift) // ctrl shift 1
        {
            e.preventDefault();
            commitToLocalStorage();
            currentReg = reg1;
            getRegContent();
        }
        else if (key == 50 && ctrl && shift) // ctrl shift 2
        {
            e.preventDefault();
            commitToLocalStorage();
            currentReg = reg2;
            getRegContent();
        }
        else if (key == 51 && ctrl && shift) // ctrl shift 3
        {
            e.preventDefault();
            commitToLocalStorage();
            currentReg = reg3;
            getRegContent();
        }
        else if (key == 52 && ctrl && shift) // ctrl shift 4
        {
            e.preventDefault();
            commitToLocalStorage();
            currentReg = reg4;
            getRegContent();
        }
        else if (key == 53 && ctrl && shift) // ctrl shift 5
        {
            e.preventDefault();
            commitToLocalStorage();
            currentReg = reg5;
            getRegContent();
        }
        else if (key == 54 && ctrl && shift) // ctrl shift 6
        {
            e.preventDefault();
            commitToLocalStorage();
            currentReg = reg6;
            getRegContent();
        }
        else if (key == 55 && ctrl && shift) // ctrl shift 7
        {
            e.preventDefault();
            commitToLocalStorage();
            currentReg = reg7;
            getRegContent();
        }
        else if (key == 56 && ctrl && shift) // ctrl shift 8
        {
            e.preventDefault();
            commitToLocalStorage();
            currentReg = reg8;
            getRegContent();
        }
        else if (key == 57 && ctrl && shift) // ctrl shift 9
        {
            e.preventDefault();
            commitToLocalStorage();
            currentReg = reg9;
            getRegContent();
        }
        else if (key == 48 && ctrl && shift) // ctrl shift 0
        {
            e.preventDefault();
            commitToLocalStorage();
            currentReg = reg0;
            getRegContent();
        }
	else if (key == 192 && ctrl && shift) // ctrl shift `
        {
            e.preventDefault();
            commitToLocalStorage();
            currentReg = regTodo;
            getRegContent();
        }
        else if (key == 191 && ctrl && shift) // ctrl shift ?
        {
            e.preventDefault();
            commitToLocalStorage();
            currentReg = regTut;
            getRegContent();
        }
        else if (key == 190 && ctrl && shift) // ctrl shift .
        {
            e.preventDefault();
            commitToLocalStorage();
            currentReg = regHome;
            getRegContent();
        }
        else if (key == 188 && ctrl && shift) // ctrl shift ,
        {
            e.preventDefault();
            commitToLocalStorage();
            currentReg = regIndex;
            getRegContent();
        }
        else if (key == 9 && shift) // shift tab
        {
            e.preventDefault();
            pushLeftBlock();
        }
        else if (key == 9) // tab
        {
            e.preventDefault();
            pushRightBlock();
        }
        else if (key == 13 && shift)
        {
            e.preventDefault();
            shiftEnterSpaceStarIfNeeded();
        }
        else if (key == 13 && ctrl)
        {
            e.preventDefault();
            enterSpaceStarIfNeededForSubPoint();
        }
        else if (key == 13) // enter
        {
            e.preventDefault();
            enterSpaceStarIfNeeded();
        }

        if (!(ctrl && key == 81)) // not ctrl Q
        {
            commitToLocalStorage();
            document.getElementById("console").innerHTML = localStorage.getItem(localStorageKey);
        }
        else
        {
            removeLocalStorage();
        }
    },false);

    textarea.addEventListener("keyup", function(e)
    {
        e = e || window.event;
        var key = e.which || e.keyCode; // keyCode detection
        var ctrl = e.ctrlKey ? e.ctrlKey : ((key === 17) ? true : false); // ctrl detection
        var shift = e.shiftKey ? e.shiftKey : ((key === 16) ? true : false); // alt detection
        if (key == 13 && ctrl) // ctrl + enter
        {
            e.preventDefault();
        }
        if (key == 13 && shift) // shift + enter
        {
            e.preventDefault();
        }
        else if (key == 13)
        {
            e.preventDefault();
        }
        getRegTitle();
    },false);
    textarea.select();
    setSelectedRange(0, 0);
}

function showMarkdown()
{
	textarea.blur();
	markdown.style.display = '';
	textarea.style.display = 'none';
}

function showTextarea()
{
	textarea.style.display = '';
	markdown.style.display = 'none';
}

function toggleMarkdown()
{
	if (markdown.style.display == 'none')
	{
		mdCursor = getSelectedRange();
		var text = textarea.value;
		var html = markdownConverter.makeHtml(text);
		markdown.innerHTML = html;
		showMarkdown();
	}
	else if (textarea.style.display == 'none')
	{
		showTextarea();
		textarea.select();
		setSelectedRange(mdCursor[0], mdCursor[1]);
	}
}

function increaseFontSize()
{
	fontSize = fontSize + 2;
	displayFontSize();
}

function decreaseFontSize()
{
	fontSize = fontSize - 2;
	displayFontSize();
}

function displayFontSize()
{
	textarea.style.fontSize = fontSize + "px";
}

function getRegTitle()
{
    document.title = '[' + currentReg + '] ' + textarea.value.split('\n')[0];
}

function getTitleOfNotes(reg)
{
	var content = localStorage.getItem(reg);
	if (content == null)
	{
		return '';
	}
	else
	{
		return content.split('\n')[0];
	}
}

function getRegContent()
{
    var localStorageItem = localStorage.getItem(currentReg);
    document.getElementById("console").innerHTML = "#" + localStorageItem + "#";
    if (currentReg == regTut)
    {
        textarea.value = tutorial;
    }
    else if (currentReg == regHome)
    {
        textarea.value = wd;
    }
    else if (currentReg == regIndex)
    {
    	var content = 'Index:\n\n';
	content = content + '* [' + regTodo + '] ' + getTitleOfNotes(regTodo) + '\n';
    	content = content + '* [' + reg1 + '] ' + getTitleOfNotes(reg1) + '\n';
    	content = content + '* [' + reg2 + '] ' + getTitleOfNotes(reg2) + '\n';
    	content = content + '* [' + reg3 + '] ' + getTitleOfNotes(reg3) + '\n';
    	content = content + '* [' + reg4 + '] ' + getTitleOfNotes(reg4) + '\n';
    	content = content + '* [' + reg5 + '] ' + getTitleOfNotes(reg5) + '\n';
    	content = content + '* [' + reg6 + '] ' + getTitleOfNotes(reg6) + '\n';
    	content = content + '* [' + reg7 + '] ' + getTitleOfNotes(reg7) + '\n';
    	content = content + '* [' + reg8 + '] ' + getTitleOfNotes(reg8) + '\n';
    	content = content + '* [' + reg9 + '] ' + getTitleOfNotes(reg9) + '\n';
    	content = content + '* [' + reg0 + '] ' + getTitleOfNotes(reg0);

    	textarea.value = content;
    }
    else if (localStorageItem != null)
    {
        textarea.value = localStorageItem;
    }
    else if (currentReg == reg1)
    {
        textarea.value = wd;
    }
    else
    {
        textarea.value = '';
    }
    getRegTitle();

    textarea.addEventListener("click", function()
    {
        var alertTxt = '';
        alertTxt += getCursor(textarea);
        alertTxt += '<br>' + getSurroundingSelection(textarea);
        document.getElementById("console").innerHTML = alertTxt;
    });
}

function commitToLocalStorage()
{
    localStorage.setItem(currentReg, textarea.value);
}

function removeLocalStorage()
{
    localStorage.removeItem(currentReg);
    textarea.blur();
    document.getElementById("console").innerHTML = localStorage.getItem(currentReg);
}

//------------------------------------------------------------------------------------------
// Drafts function

function getText()
{
    // returns the full text currently being edited
    return textarea.value;
}

function setText(string)
{
    // replaces full text being edited with string
    textarea.value = string;
}

function getSelectedText()
{
    // return only the selected text. If no text selection exists, this will return an empty string.
    return getMiddleCursorSelection();
}

function setSelectedText(string)
{
    // Replace only the current selected text range with the string. Also updates the selected range to match any change in length of the new string.
    textarea.value = getBeforeCursorSelection() + string + getAfterCursorSelection();
}

function getTextInRange(start, length)
{

    // Return text in the request range.
    return textarea.value.substring(start, start + length);
}

function setTextInRange(start, length, string)
{
    // Replace the text in the specified range with the value of string.
    var text = string;

    // method 1
    //textarea.value = textarea.value.substring(0, start) + string + textarea.value.substring(start + length, textarea.value.length);

    // method 2
    setSelectedRange(start, length);
    document.execCommand('insertText', false, text);

    // method 3
    //var event = document.createEvent('TextEvent');
    //setSelectedRange(start, length);
    //event.initTextEvent('textInput', true, true, null, text || "\0");
    //textarea.dispatchEvent(event); // fire the event on the the textarea
}
function getSelectedLineRange()
{
    // Returns the range (start,length) of the full line based on the current cursor position
    return getCurrentLine(getCursor());
}
function getSelectedRange()
{
    // Returns the current selected text range as an array with values [start, length].
    var result = new Array();
    result[0] = textarea.selectionStart;
    result[1] = textarea.selectionEnd - textarea.selectionStart;
    return result;
}
function setSelectedRange(start, length)
{
    // Set the selected range of text. Invalid ranges will be automatically adjusted, and this text selection will be applied after successful completion of the script.
    setSelectionRange(start, start + length);
}
function getClipboard()
{
    // Returns current contents of the system clipboard.
    // Not supported yet
}
function setClipboard(string)
{

    // Set the system clipboard to the string passed.
    // Not supported yet
}
function markdown(string, useXHTML)
{

    // runs the string through the Markdown processor returning HTML.
    // Not supported yet
}
function encodeHTMLEntities(string)
{
    // Encodes the string to HTML safe entities, e.g. converting & to &amp;
    // Not supported yet
}
function decodeHTMLEntities(string)
{
    //Decodes HTML entities.
    // Not supported yet
}

//---------------------------------------------------------------------------------------------------
// Drafts adapter function

function setSelectionRange(selectionStart, selectionEnd)
{
    if (textarea.setSelectionRange)
    {
        textarea.focus();
        textarea.setSelectionRange(selectionStart, selectionEnd);
    }
    else if (textarea.createTextRange)
    {
        var range = textarea.createTextRange();
        range.collapse(true);
        range.moveEnd('character', selectionEnd);
        range.moveStart('character', selectionStart);
        range.select();
    }
}

function setCaretToPos(pos)
{
    setSelectionRange(pos, pos);
}

function getSurroundingSelection()
{
    return [textarea.value.substring(0, textarea.selectionStart)
        ,textarea.value.substring(textarea.selectionStart, textarea.selectionEnd)
        ,textarea.value.substring(textarea.selectionEnd, textarea.value.length)]
}
function getBeforeCursorSelection()
{
    return textarea.value.substring(0, textarea.selectionStart);
}
function getMiddleCursorSelection()
{
    return textarea.value.substring(textarea.selectionStart, textarea.selectionEnd);
}
function getAfterCursorSelection()
{
    return textarea.value.substring(textarea.selectionEnd, textarea.value.length);
}

//-------------------------------------------------------------------------------------------------
// Self function
function toggleRightNonPointsCheckBox()
{
	var cursor = getCursor();
	var todoNotDone1 = getTextInRange(cursor, 4) == "[ ] ";
	var todoNotDone2 = getTextInRange(cursor - 1, 4) == "[ ] ";
	var todoNotDone3 = getTextInRange(cursor - 2, 4) == "[ ] ";
	var todoNotDone4 = getTextInRange(cursor - 3, 4) == "[ ] ";
	var todoDone1 = getTextInRange(cursor, 4) == "[x] ";
	var todoDone2 = getTextInRange(cursor - 1, 4) == "[x] ";
	var todoDone3 = getTextInRange(cursor - 2, 4) == "[x] ";
	var todoDone4 = getTextInRange(cursor - 3, 4) == "[x] ";
	var todoWaitingFor1 = getTextInRange(cursor, 4) == "[w] ";
	var todoWaitingFor2 = getTextInRange(cursor - 1, 4) == "[w] ";
	var todoWaitingFor3 = getTextInRange(cursor - 2, 4) == "[w] ";
	var todoWaitingFor4 = getTextInRange(cursor - 3, 4) == "[w] ";
	var todoInProgress1 = getTextInRange(cursor, 4) == "[p] ";
	var todoInProgress2 = getTextInRange(cursor - 1, 4) == "[p] ";
	var todoInProgress3 = getTextInRange(cursor - 2, 4) == "[p] ";
	var todoInProgress4 = getTextInRange(cursor - 3, 4) == "[p] ";
	var todoDropped1 = getTextInRange(cursor, 4) == "[d] ";
	var todoDropped2 = getTextInRange(cursor - 1, 4) == "[d] ";
	var todoDropped3 = getTextInRange(cursor - 2, 4) == "[d] ";
	var todoDropped4 = getTextInRange(cursor - 3, 4) == "[d] ";
	if (todoNotDone1)
	{
		setTextInRange(cursor, 4, "[x] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoNotDone2)
	{
		setTextInRange(cursor - 1, 4, "[x] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoNotDone3)
	{
		setTextInRange(cursor - 2, 4, "[x] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoNotDone4)
	{
		setTextInRange(cursor - 3, 4, "[x] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoDone1)
	{
		setTextInRange(cursor, 4, "[w] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoDone2)
	{
		setTextInRange(cursor - 1, 4, "[w] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoDone3)
	{
		setTextInRange(cursor - 2, 4, "[w] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoDone4)
	{
		setTextInRange(cursor - 3, 4, "[w] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoWaitingFor1)
	{
		setTextInRange(cursor, 4, "[p] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoWaitingFor2)
	{
		setTextInRange(cursor - 1, 4, "[p] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoWaitingFor3)
	{
		setTextInRange(cursor - 2, 4, "[p] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoWaitingFor4)
	{
		setTextInRange(cursor - 3, 4, "[p] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoInProgress1)
	{
		setTextInRange(cursor, 4, "[d] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoInProgress2)
	{
		setTextInRange(cursor - 1, 4, "[d] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoInProgress3)
	{
		setTextInRange(cursor - 2, 4, "[d] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoInProgress4)
	{
		setTextInRange(cursor - 3, 4, "[d] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoDropped1)
	{
		setTextInRange(cursor, 4, "");
		setSelectedRange(cursor, 0);
	}
	else if (todoDropped2)
	{
		setTextInRange(cursor - 1, 4, "");
		setSelectedRange(cursor - 1, 0);
	}
	else if (todoDropped3)
	{
		setTextInRange(cursor - 2, 4, "");
		setSelectedRange(cursor - 2, 0);
	}
	else if (todoDropped4)
	{
		setTextInRange(cursor - 3, 4, "");
		setSelectedRange(cursor - 3, 0);
	}
	else 
	{
		setTextInRange(cursor, 0, "[ ] ");
		setSelectedRange(cursor + 4, 0);
	}
}

function toggleLeftNonPointsCheckBox()
{
	var cursor = getCursor();
	var todoNotDone1 = getTextInRange(cursor, 4) == "[ ] ";
	var todoNotDone2 = getTextInRange(cursor - 1, 4) == "[ ] ";
	var todoNotDone3 = getTextInRange(cursor - 2, 4) == "[ ] ";
	var todoNotDone4 = getTextInRange(cursor - 3, 4) == "[ ] ";
	var todoDone1 = getTextInRange(cursor, 4) == "[x] ";
	var todoDone2 = getTextInRange(cursor - 1, 4) == "[x] ";
	var todoDone3 = getTextInRange(cursor - 2, 4) == "[x] ";
	var todoDone4 = getTextInRange(cursor - 3, 4) == "[x] ";
	var todoWaitingFor1 = getTextInRange(cursor, 4) == "[w] ";
	var todoWaitingFor2 = getTextInRange(cursor - 1, 4) == "[w] ";
	var todoWaitingFor3 = getTextInRange(cursor - 2, 4) == "[w] ";
	var todoWaitingFor4 = getTextInRange(cursor - 3, 4) == "[w] ";
	var todoInProgress1 = getTextInRange(cursor, 4) == "[p] ";
	var todoInProgress2 = getTextInRange(cursor - 1, 4) == "[p] ";
	var todoInProgress3 = getTextInRange(cursor - 2, 4) == "[p] ";
	var todoInProgress4 = getTextInRange(cursor - 3, 4) == "[p] ";
	var todoDropped1 = getTextInRange(cursor, 4) == "[d] ";
	var todoDropped2 = getTextInRange(cursor - 1, 4) == "[d] ";
	var todoDropped3 = getTextInRange(cursor - 2, 4) == "[d] ";
	var todoDropped4 = getTextInRange(cursor - 3, 4) == "[d] ";
	if (todoNotDone1)
	{
		setTextInRange(cursor, 4, "");
		setSelectedRange(cursor, 0);
	}
	else if (todoNotDone2)
	{
		setTextInRange(cursor - 1, 4, "");
		setSelectedRange(cursor - 1, 0);
	}
	else if (todoNotDone3)
	{
		setTextInRange(cursor - 2, 4, "");
		setSelectedRange(cursor - 2, 0);
	}
	else if (todoNotDone4)
	{
		setTextInRange(cursor - 3, 4, "");
		setSelectedRange(cursor - 3, 0);
	}
	else if (todoDone1)
	{
		setTextInRange(cursor, 4, "[ ] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoDone2)
	{
		setTextInRange(cursor - 1, 4, "[ ] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoDone3)
	{
		setTextInRange(cursor - 2, 4, "[ ] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoDone4)
	{
		setTextInRange(cursor - 3, 4, "[ ] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoWaitingFor1)
	{
		setTextInRange(cursor, 4, "[x] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoWaitingFor2)
	{
		setTextInRange(cursor - 1, 4, "[x] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoWaitingFor3)
	{
		setTextInRange(cursor - 2, 4, "[x] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoWaitingFor4)
	{
		setTextInRange(cursor - 3, 4, "[x] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoInProgress1)
	{
		setTextInRange(cursor, 4, "[w] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoInProgress2)
	{
		setTextInRange(cursor - 1, 4, "[w] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoInProgress3)
	{
		setTextInRange(cursor - 2, 4, "[w] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoInProgress4)
	{
		setTextInRange(cursor - 3, 4, "[w] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoDropped1)
	{
		setTextInRange(cursor, 4, "[p] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoDropped2)
	{
		setTextInRange(cursor - 1, 4, "[p] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoDropped3)
	{
		setTextInRange(cursor - 2, 4, "[p] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoDropped4)
	{
		setTextInRange(cursor - 3, 4, "[p] ");
		setSelectedRange(cursor, 0);
	}
	else 
	{
		setTextInRange(cursor, 0, "[d] ");
		setSelectedRange(cursor + 4, 0);
	}
}

function nonPointsTodo()
{
	var cursor = getCursor();
	var todoNotDone1 = getTextInRange(cursor, 4) == "[ ] ";
	var todoNotDone2 = getTextInRange(cursor - 1, 4) == "[ ] ";
	var todoNotDone3 = getTextInRange(cursor - 2, 4) == "[ ] ";
	var todoNotDone4 = getTextInRange(cursor - 3, 4) == "[ ] ";
	var todoDone1 = getTextInRange(cursor, 4) == "[x] ";
	var todoDone2 = getTextInRange(cursor - 1, 4) == "[x] ";
	var todoDone3 = getTextInRange(cursor - 2, 4) == "[x] ";
	var todoDone4 = getTextInRange(cursor - 3, 4) == "[x] ";
	if (todoNotDone1)
	{
		setTextInRange(cursor, 4, "[x] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoNotDone2)
	{
		setTextInRange(cursor - 1, 4, "[x] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoNotDone3)
	{
		setTextInRange(cursor - 2, 4, "[x] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoNotDone4)
	{
		setTextInRange(cursor - 3, 4, "[x] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoDone1)
	{
		setTextInRange(cursor, 4, "[ ] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoDone2)
	{
		setTextInRange(cursor - 1, 4, "[ ] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoDone3)
	{
		setTextInRange(cursor - 2, 4, "[ ] ");
		setSelectedRange(cursor, 0);
	}
	else if (todoDone4)
	{
		setTextInRange(cursor - 3, 4, "[ ] ");
		setSelectedRange(cursor, 0);
	}
	else 
	{
		setTextInRange(cursor, 0, "[ ] ");
		setSelectedRange(cursor + 4, 0);
	}
}


function replace()
{
	var reStr = prompt("Please enter find with words", "");
	if (reStr == null ||reStr == "")
	{
		return;
	}
	var re = new RegExp(reStr, "g");
	var replaceStr = prompt("Please enter word to replace '" + reStr + "'", "");
	var text = getText();
	if (replaceStr == null)
	{
		return;
	}
	setTextInRange(0, text.length, text.replace(re, replaceStr));
}

function getCursor()
{
    return getSelectedRange()[0];
}

function insertTableDelimiter()
{
	setTextInRange(getCursor(), 0, ' | ');
}

function emptyLine()
{
	var lnRange = getSelectedLineRange();
    var currentLineText = getTextInRange(lnRange[0], lnRange[1]);
    if (currentLineText.endsWith("\n"))
    {
    	setTextInRange(lnRange[0], lnRange[1], "\n");
    	setSelectedRange(lnRange[0], 0);
    }
    else
    {
        setTextInRange(lnRange[0], lnRange[1], "");
    	setSelectedRange(lnRange[0] + 1, 0);
    }
}

function gotoPreviousLine()
{
    var cursor = getCursor();
    if (isFirstLine(cursor))
    {
        return;
    }
    var previousLine = getPreviousLine(cursor);
    setSelectedRange(previousLine[0] + previousLine[1] - 1, 0);
}

function gotoEndOfLine()
{
    var lnRange = getSelectedLineRange();
    var currentLineText = getTextInRange(lnRange[0], lnRange[1]);
    if (currentLineText.endsWith('\n'))
    {
        setSelectedRange(lnRange[0] + lnRange[1] - 1, 0);
    }
    else
    {
        setSelectedRange(lnRange[0] + lnRange[1], 0);
    }
}

function shiftEnterSpaceStarIfNeeded()
{
    var cursor = getCursor();
    var lnRange = getCurrentLine(cursor);
    var currentLineText = getTextInRange(lnRange[0], lnRange[1]);
    if (currentLineText.match(/^ *\* /))
    {
        var currentLineStarPos = currentLineText.indexOf('* ');
        var result = "\n";
        for (var i = 0; i < currentLineStarPos; i++)
        {
            result += " ";
        }
        result += "* ";
        var cursor = lnRange[0];
        if (cursor == 0)
        {
            setTextInRange(cursor, 0, result);
            setSelectedRange(cursor + result.length, 0);
        }
        else
        {
            setTextInRange(cursor - 1, 0, result);
            setSelectedRange(cursor + result.length - 1, 0);
        }
    }
    else
    {
        var currentLineSpacePos = currentLineText.search(/[^ ]/);
        var result = "\n";
        for (var i = 0; i < currentLineSpacePos; i++)
        {
            result += " ";
        }
        var cursor = lnRange[0];
        if (cursor == 0)
        {
            setTextInRange(cursor, 0, result);
            setSelectedRange(cursor + result.length, 0);
        }
        else
        {
            setTextInRange(cursor - 1, 0, result);
            setSelectedRange(cursor + result.length - 1, 0);
        }
    }
}

function enterSpaceStarIfNeeded()
{
    var lnRange = getSelectedLineRange();
    var currentLineText = getTextInRange(lnRange[0], lnRange[1]);
    if (currentLineText.match(/^ *\* \[ \] /))
    {
        gotoEndOfLine();
        var currentLineStarPos = currentLineText.indexOf('* [ ] ');

        var cursor = getCursor();
        var currentPoint = getCurrentPoint(cursor);
        var nextLine = getNextLine(currentPoint[0] + 1);
        if (nextLine == -1)
        {
            // next line is last line
        }
        else
        {
            var nextPointText = getTextInRange(nextLine[0], nextLine[1]);
            var nextPointTextStarPos = nextPointText.indexOf('* ');
            if (nextPointTextStarPos > currentLineStarPos)
            {
                currentLineStarPos = nextPointTextStarPos;
            }
        }

        var result = "\n";
        for (var i = 0; i < currentLineStarPos; i++)
        {
            result += " ";
        }
        result += "* [ ] ";

        if (isLastLine(cursor))
        {
            setTextInRange(currentPoint[0] + currentPoint[1], 0, result);
             setSelectedRange(currentPoint[0] + currentPoint[1] + result.length, 0);
        }
        else
        {
            setTextInRange(currentPoint[0] + currentPoint[1] - 1, 0, result);
            setSelectedRange(currentPoint[0] + currentPoint[1] - 1 + result.length, 0);
        }
    }
    else if (currentLineText.match(/^ *\* \[x\] /))
    {
        gotoEndOfLine();
        var currentLineStarPos = currentLineText.indexOf('* [x] ');

        var cursor = getCursor();
        var currentPoint = getCurrentPoint(cursor);
        var nextLine = getNextLine(currentPoint[0] + 1);
        if (nextLine == -1)
        {
            // next line is last line
        }
        else
        {
            var nextPointText = getTextInRange(nextLine[0], nextLine[1]);
            var nextPointTextStarPos = nextPointText.indexOf('* ');
            if (nextPointTextStarPos > currentLineStarPos)
            {
                currentLineStarPos = nextPointTextStarPos;
            }
        }

        var result = "\n";
        for (var i = 0; i < currentLineStarPos; i++)
        {
            result += " ";
        }
        result += "* [ ] ";

        if (isLastLine(cursor))
        {
            setTextInRange(currentPoint[0] + currentPoint[1], 0, result);
             setSelectedRange(currentPoint[0] + currentPoint[1] + result.length, 0);
        }
        else
        {
            setTextInRange(currentPoint[0] + currentPoint[1] - 1, 0, result);
            setSelectedRange(currentPoint[0] + currentPoint[1] - 1 + result.length, 0);
        }
    }
    else if (currentLineText.match(/^ *\* /))
    {
        gotoEndOfLine();
        var currentLineStarPos = currentLineText.indexOf('* ');

        var cursor = getCursor();
        var currentPoint = getCurrentPoint(cursor);
        var nextLine = getNextLine(currentPoint[0] + 1);
        if (nextLine == -1)
        {
            // next line is last line
        }
        else
        {
            var nextPointText = getTextInRange(nextLine[0], nextLine[1]);
            var nextPointTextStarPos = nextPointText.indexOf('* ');
            if (nextPointTextStarPos > currentLineStarPos)
            {
                currentLineStarPos = nextPointTextStarPos;
            }
        }

        var result = "\n";
        for (var i = 0; i < currentLineStarPos; i++)
        {
            result += " ";
        }
        result += "* ";

        if (isLastLine(cursor))
        {
            setTextInRange(currentPoint[0] + currentPoint[1], 0, result);
             setSelectedRange(currentPoint[0] + currentPoint[1] + result.length, 0);
        }
        else
        {
            setTextInRange(currentPoint[0] + currentPoint[1] - 1, 0, result);
            setSelectedRange(currentPoint[0] + currentPoint[1] - 1 + result.length, 0);
        }
    }
    else
    {
        var currentLineSpacePos = currentLineText.search(/[^ ]/);
        var result = "";
        for (var i = 0; i < currentLineSpacePos; i++)
        {
            result += " ";
        }
        var cursor = getCursor();
        setTextInRange(cursor, 0, '  \n' + result);
        setSelectedRange(cursor + 3 + result.length, 0);
    }
}

function enterSpaceStarIfNeededForSubPoint()
{
    var lnRange = getSelectedLineRange();
    var currentLineText = getTextInRange(lnRange[0], lnRange[1]);
    if (currentLineText.match(/^ *\* /))
    {
        gotoEndOfLine();
        var currentLineStarPos = currentLineText.indexOf('* ');

        var cursor = getCursor();
        var currentPoint = getCurrentPoint(cursor);

        var result = "\n";
        for (var i = 0; i < currentLineStarPos + 4; i++)
        {
            result += " ";
        }
        result += "* ";

        if (isLastLine(cursor))
        {
            setTextInRange(currentPoint[0] + currentPoint[1], 0, result);
             setSelectedRange(currentPoint[0] + currentPoint[1] + result.length, 0);
        }
        else
        {
            setTextInRange(currentPoint[0] + currentPoint[1] - 1, 0, result);
            setSelectedRange(currentPoint[0] + currentPoint[1] - 1 + result.length, 0);
        }
    }
    else
    {
        gotoEndOfLine();
        var currentLineSpacePos = currentLineText.search(/[^ ]/);
        var result = "";
        for (var i = 0; i < currentLineSpacePos; i++)
        {
            result += " ";
        }
        var cursor = getCursor();
        setTextInRange(cursor, 0, '  \n' + result);
        setSelectedRange(cursor + 3 + result.length, 0);
    }
}

function getCurrentLine(startCharPos)
{
    var startPos;
    var length = 0;
    if (startCharPos == 0)
    {
        startPos = startCharPos;
    }
    else
    {
        startPos = startCharPos;
        var calls = 0;
        while (startPos > 0 && getTextInRange(startPos - 1, 1) != '\n')
        {
            calls += 1;
            if (calls > maxCallCount)
            {
                alert("inf loop: getCurrentLine()");
                break;
            }
            startPos--;
        }
    }
    var tempPos = startPos;
    var allTextLength = getText().length;
    var calls = 0;
    while (tempPos < allTextLength && getTextInRange(tempPos, 1) != '\n')
    {
        calls += 1;
        if (calls > maxCallCount)
        {
            alert("inf loop: getCurrentLine()");
            break;
        }
        tempPos++;
        length++;
    }
    if (tempPos != allTextLength)
    {
        length++;
    }
    var result = new Array();
    result[0] = startPos;
    result[1] = length;
    return result;
}

function getStarPos(cursor)
{
    var lnRange = getCurrentLine(cursor);
    var text = getTextInRange(lnRange[0], lnRange[1]);
    if (text.match(/^ *\* /))
    {
        var starLength = 0;
        var startPos = lnRange[0];
        var calls = 0;
        while (getTextInRange(startPos, 1) != '*')
        {
            calls += 1;
            if (calls > maxCallCount)
            {
                alert("inf loop: getStarPos()");
                break;
            }
            startPos++;
            starLength++;
        }
        return starLength;
    }
    return -1;
}

function cursorPos(cursor)
{
    return cursor - getCurrentLine(cursor)[0];
}

function currentCursorPos()
{
    return getSelectedRange()[0] - getSelectedLineRange()[0];
}

function isFirstLine(cursor)
{
    return getCurrentLine(cursor)[0] == 0;
}

function isLastLine(cursor)
{
    var lnRange = getCurrentLine(cursor);
    return lnRange[0] + lnRange[1] == getText().length;
}

function getPreviousLine(cursor)
{
    if (isFirstLine(cursor))
    {
        return -1;
    }
    else
    {
        var pos = getCurrentLine(cursor)[0] - 1;
        return getCurrentLine(pos);
    }
}

function getNextLine(cursor)
{
    if (isLastLine(cursor))
    {
        return -1;
    }
    else
    {
        var lnRange = getCurrentLine(cursor);
        var pos = lnRange[0] + lnRange[1];
        return getCurrentLine(pos);
    }
}

function getPreviousBlock(cursor)
{
    var starPos = getStarPos(cursor);
    var currentLine = getCurrentLine(cursor);
    if (starPos == -1)
    {
        return -1;
    }
    var startPos = currentLine[0];
    var starPosCurrentLine = getStarPos(currentLine[0]);
    var found = false;
    var previousBlockPos = -1;
    var calls = 0;
    while (!found && !isFirstLine(startPos))
    {
        calls += 1;
        if (calls > maxCallCount)
        {
            alert("inf loop: getPreviousBlock()");
            break;
        }
        var previousLine = getPreviousLine(startPos);
        startPos = previousLine[0];
        if (previousLine[1] == 1) // empty line
        {
            break;
        }
        if (getStarPos(startPos) == starPosCurrentLine)
        {
            found = true;
            previousBlockPos = startPos;
        }
    }
    if (found)
    {
        var previousBlock = new Array();
        previousBlock[0] = previousBlockPos;
        previousBlock[1] = currentLine[0] - previousBlockPos;
        return previousBlock;
    }
    else
    {
        return -1;
    }
}

// at star line use, get current point with comment
function getCurrentPoint(cursor)
{
    var starPos = getStarPos(cursor);
    var currentLine = getCurrentLine(cursor);
    if (starPos == -1)
    {
        return -1;
    }
    if (isLastLine(cursor))
    {
        return currentLine;
    }
    var startPos = currentLine[0];
    var found = false;
    var calls = 0;
    while(!found && !isLastLine(startPos))
    {
        calls += 1;
        if (calls > maxCallCount)
        {
            alert("inf loop: getCurrentPoint()");
            break;
        }
        var nextLine = getNextLine(startPos);
        startPos = nextLine[0];
        if (nextLine[1] == 1) // empty line
        {
            startPos = getCurrentLine(startPos - 1)[0];
            break;
        }
        var currentStarPos = getStarPos(startPos);
        if (currentStarPos >= 0)
        {
            found = true;
        }
    }
    if (found)
    {
        startPos = getPreviousLine(startPos)[0];
        var result = new Array();
        result[0] = currentLine[0];
        result[1] = startPos + getCurrentLine(startPos)[1] - currentLine[0];
        return result;
    }
    else
    {
        var result = new Array();
        result[0] = currentLine[0];
        result[1] = startPos + getCurrentLine(startPos)[1] - currentLine[0];
        return result;
    }
}

function getCurrentBlock(cursor)
{
    var starPos = getStarPos(cursor);
    var currentLine = getCurrentLine(cursor);
    if (starPos == -1)
    {
        return -1;
    }
    if (isLastLine(cursor))
    {
        return currentLine;
    }
    var startPos = currentLine[0];
    var found = false;
    var calls = 0;
    while(!found && !isLastLine(startPos))
    {
        calls += 1;
        if (calls > maxCallCount)
        {
            alert("inf loop: getCurrentBlock()");
            break;
        }
        var nextLine = getNextLine(startPos);
        startPos = nextLine[0];
        if (nextLine[1] == 1) // empty line
        {
            startPos = getCurrentLine(startPos - 1)[0];
            break;
        }
        var currentStarPos = getStarPos(startPos);
        if (currentStarPos >= 0 && currentStarPos <= starPos)
        {
            found = true;
        }
    }
    if (found)
    {
        startPos = getPreviousLine(startPos)[0];
        var result = new Array();
        result[0] = currentLine[0];
        result[1] = startPos + getCurrentLine(startPos)[1] - currentLine[0];
        return result;
    }
    else
    {
        var result = new Array();
        result[0] = currentLine[0];
        result[1] = startPos + getCurrentLine(startPos)[1] - currentLine[0];
        return result;
    }
}

function getNextBlock(cursor)
{
    var starPos = getStarPos(cursor);
    var currentLine = getCurrentLine(cursor);
    if (starPos == -1)
    {
        return -1;
    }
    if (isLastLine(cursor))
    {
        return -1;
    }
    var startPos = currentLine[0];
    var found = false;
    var calls = 0;
    while(!found && !isLastLine(startPos))
    {
        calls += 1;
        if (calls > maxCallCount)
        {
            alert("inf loop: getNextBlock()");
            break;
        }
        var nextLine = getNextLine(startPos);
        startPos = nextLine[0];
        var currentStarPos = getStarPos(startPos);
        if (nextLine[1] == 1) // empty line
        {
            return -1;
        }
        if (currentStarPos >= 0 && currentStarPos < starPos)
        {
            return -1;
        }
        if (currentStarPos == starPos)
        {
            return getCurrentBlock(startPos);
        }
    }
    return -1;
}

function pushDownBlock()
{
    var currentCursorWidth = currentCursorPos();
    var cursor = getSelectedLineRange()[0];
    var currentBlock = getCurrentBlock(cursor);
    var nextBlock = getNextBlock(cursor);
    if (currentBlock == -1 || nextBlock == -1)
    {
        return;
    }
    var currentBlockContent = getTextInRange(currentBlock[0], currentBlock[1]);
    var nextBlockContent = getTextInRange(nextBlock[0], nextBlock[1]);
    if (!nextBlockContent.endsWith('\n'))
    {
        nextBlockContent = nextBlockContent + '\n';
    }
    setTextInRange(cursor, currentBlock[1] + nextBlock[1], nextBlockContent + currentBlockContent);
    setSelectedRange(cursor + nextBlockContent.length + currentCursorWidth, 0);
}

function pushUpBlock()
{
    var currentCursorWidth = currentCursorPos();
    var cursor = getSelectedLineRange()[0];
    var currentBlock = getCurrentBlock(cursor);
    var previousBlock = getPreviousBlock(cursor);
    if (currentBlock == -1 || previousBlock == -1)
    {
        return;
    }
    var currentBlockContent = getTextInRange(currentBlock[0], currentBlock[1]);
    var previousBlockContent = getTextInRange(previousBlock[0], previousBlock[1]);
    if (!currentBlockContent.endsWith('\n'))
    {
        currentBlockContent = currentBlockContent + '\n';
    }
    setTextInRange(previousBlock[0], previousBlock[1] + currentBlock[1], currentBlockContent + previousBlockContent);
    setSelectedRange(previousBlock[0] + currentCursorWidth, 0);
}

function indentBlock(text)
{
    var endsWithNewLine = text.endsWith('\n');
    if (endsWithNewLine)
    {
        text = text.substring(0, text.length - 1);
    }
    var lines = text.split('\n');
    for (var i = 0; i < lines.length; i++)
    {
        lines[i] = lines[i].replace(/^/, '    ');
    }
    var result = lines.join('\n');
    if (endsWithNewLine)
    {
        result = result + '\n';
    }
    return result;
}

function outdentBlock(text)
{
    var endsWithNewLine = text.endsWith('\n');
    if (endsWithNewLine)
    {
        text = text.substring(0, text.length - 1);
    }
    var lines = text.split('\n');
    for (var i = 0; i < lines.length; i++)
    {
        lines[i] = lines[i].replace(/^    /, '');
    }
    var result = lines.join('\n');
    if (endsWithNewLine)
    {
        result = result + '\n';
    }
    return result;
}

function pushRightBlock()
{
    var lnRange = getSelectedLineRange();
    var currentLine = getTextInRange(lnRange[0], lnRange[1]);
    if (!currentLine.match(/ *\*/))
    {
        moveRight();
    }
    else
    {
        var currentCursorWidth = currentCursorPos();
        var cursor = getSelectedLineRange()[0];
        var currentBlock = getCurrentBlock(cursor);
        var currentBlockContent = getTextInRange(currentBlock[0], currentBlock[1]);
        var replacedContent = indentBlock(currentBlockContent);
        setTextInRange(currentBlock[0], currentBlock[1], replacedContent);
        setSelectedRange(currentBlock[0] + currentCursorWidth + 4, 0);
    }
}


function pushLeftBlock()
{
    var lnRange = getSelectedLineRange();
    var currentLine = getTextInRange(lnRange[0], lnRange[1]);
    if (!currentLine.startsWith('    '))
    {
        return;
    }
    if (!currentLine.match(/ *\*/))
    {
        moveLeft();
    }
    else
    {
        var currentCursorWidth = currentCursorPos();
        var cursor = getSelectedLineRange()[0];
        var currentBlock = getCurrentBlock(cursor);
        var currentBlockContent = getTextInRange(currentBlock[0], currentBlock[1]);
        var replacedContent = outdentBlock(currentBlockContent);
        setTextInRange(currentBlock[0], currentBlock[1], replacedContent);
        var minusCursor = 0;
        if (currentCursorWidth - 4 > 0)
        {
            minusCursor = currentCursorWidth - 4;
        }
        setSelectedRange(currentBlock[0] + minusCursor, 0);
    }
}

function checkBoxExists(cursor)
{
    var currentLine = getCurrentLine(cursor);
    var currentLineText = getTextInRange(currentLine[0], currentLine[1]);
    if (currentLineText.match(/\* \[ \] /))
    {
        return true;
    }
    else if (currentLineText.match(/\* \[x\] /))
    {
        return true;
    }
    else
    {
        return false;
    }
}

function checkBoxIsChecked(cursor)
{
    var currentLine = getCurrentLine(cursor);
    var currentLineText = getTextInRange(currentLine[0], currentLine[1]);
    if (currentLineText.match(/\* \[x\] /))
    {
        return true;
    }
    else
    {
        return false;
    }
}

function checkBoxIsNotChecked(cursor)
{
    var currentLine = getCurrentLine(cursor);
    var currentLineText = getTextInRange(currentLine[0], currentLine[1]);
    if (currentLineText.match(/\* \[ \] /))
    {
        return true;
    }
    else
    {
        return false;
    }
}

function insertCheckBox(cursor)
{
    if (getStarPos(cursor) == -1)
    {
        return;
    }
    var currentLine = getCurrentLine(cursor);
    var currentRange = getSelectedRange();
    var currentLineText = getTextInRange(currentLine[0], currentLine[1]);
    var checkBox = currentLineText.replace(/\* /, '* \[ \] ');
    setTextInRange(currentLine[0], currentLine[1], checkBox);
    setSelectedRange(currentRange[0] + 4, 0);
}

function toggleRightCheckBox()
{
	var range = getSelectedRange();
	if (range[1] >= 1)
	{
		return;
	}
	var cursor = range[0];
    var currentLine = getCurrentLine(cursor);
    var currentLineText = getTextInRange(currentLine[0], currentLine[1]);
    var notChecked = /\* \[ \] /;
    var checked    = /\* \[x\] /;
    var waitingFor = /\* \[w\] /;
    var inProgress = /\* \[p\] /;
    var dropped    = /\* \[d\] /;
    var noTodo     = /\* /;
    if (currentLineText.match(notChecked))
    {
        currentLineText = currentLineText.replace(notChecked, '* [x] ');
        setTextInRange(currentLine[0], currentLine[1], currentLineText);
        setSelectedRange(cursor, 0);
    }
    else if (currentLineText.match(checked))
    {
        currentLineText = currentLineText.replace(checked, '* [w] ');
        setTextInRange(currentLine[0], currentLine[1], currentLineText);
        setSelectedRange(cursor, 0);
    }
    else if (currentLineText.match(waitingFor))
    {
        currentLineText = currentLineText.replace(waitingFor, '* [p] ');
        setTextInRange(currentLine[0], currentLine[1], currentLineText);
        setSelectedRange(cursor, 0);
    }
    else if (currentLineText.match(inProgress))
    {
        currentLineText = currentLineText.replace(inProgress, '* [d] ');
        setTextInRange(currentLine[0], currentLine[1], currentLineText);
        setSelectedRange(cursor, 0);
    }
    else if (currentLineText.match(dropped))
    {
    	currentLineText = currentLineText.replace(dropped, '* ');
        setTextInRange(currentLine[0], currentLine[1], currentLineText);
        setSelectedRange(cursor - 4, 0);
    }
    else if (currentLineText.match(noTodo))
    {
    	insertCheckBox(cursor);
    }
}

function toggleLeftCheckBox()
{
	var range = getSelectedRange();
	if (range[1] >= 1)
	{
		return;
	}
	var cursor = range[0];
    var currentLine = getCurrentLine(cursor);
    var currentLineText = getTextInRange(currentLine[0], currentLine[1]);
    var notChecked = /\* \[ \] /;
    var checked    = /\* \[x\] /;
    var waitingFor = /\* \[w\] /;
    var inProgress = /\* \[p\] /;
    var dropped    = /\* \[d\] /;
    var noTodo     = /\* /;
    if (currentLineText.match(notChecked))
    {
    	currentLineText = currentLineText.replace(notChecked, '* ');
        setTextInRange(currentLine[0], currentLine[1], currentLineText);
        setSelectedRange(cursor - 4, 0);
    }
    else if (currentLineText.match(checked))
    {
    	currentLineText = currentLineText.replace(checked, '* [ ] ');
        setTextInRange(currentLine[0], currentLine[1], currentLineText);
        setSelectedRange(cursor, 0);
    }
    else if (currentLineText.match(waitingFor))
    {
    	currentLineText = currentLineText.replace(waitingFor, '* [x] ');
        setTextInRange(currentLine[0], currentLine[1], currentLineText);
        setSelectedRange(cursor, 0);
    }
    else if (currentLineText.match(inProgress))
    {
    	currentLineText = currentLineText.replace(inProgress, '* [w] ');
        setTextInRange(currentLine[0], currentLine[1], currentLineText);
        setSelectedRange(cursor, 0);
    }
    else if (currentLineText.match(dropped))
    {
    	currentLineText = currentLineText.replace(dropped, '* [p] ');
        setTextInRange(currentLine[0], currentLine[1], currentLineText);
        setSelectedRange(cursor, 0);
    }
    else if (currentLineText.match(noTodo))
    {
    	currentLineText = currentLineText.replace(noTodo, '* [d] ');
        setTextInRange(currentLine[0], currentLine[1], currentLineText);
        setSelectedRange(cursor, 0);
    }
}

function toggleCheckBox(cursor)
{
    var currentLine = getCurrentLine(cursor);
    var currentLineText = getTextInRange(currentLine[0], currentLine[1]);
    var notChecked = /\* \[ \] /;
    var checked    = /\* \[x\] /;
    if (currentLineText.match(notChecked))
    {
        currentLineText = currentLineText.replace(notChecked, '* [x] ');
        setTextInRange(currentLine[0], currentLine[1], currentLineText);
        setSelectedRange(cursor, 0);
    }
    else if (currentLineText.match(checked))
    {
        currentLineText = currentLineText.replace(checked, '* [ ] ');
        setTextInRange(currentLine[0], currentLine[1], currentLineText);
        setSelectedRange(cursor, 0);
    }
}

function handleCheckBox()
{
    var cursor = getCursor();
    if (checkBoxExists(cursor))
    {
        toggleCheckBox(cursor);
    }
    else
    {
        insertCheckBox(cursor);
    }
}

function moveLeft()
{
	var lnRange = getSelectedRange();
	var startRange = getCurrentLine(lnRange[0]);
	var endRange = getCurrentLine(lnRange[0] + lnRange[1]);
	var startPos = startRange[0];
	var contentLength = 0;
	if (getTextInRange(endRange[1] + endRange[0] - 1, 1) == "\n")
	{
		contentLength = endRange[1] + endRange[0] - startRange[0] - 1;
	}
	else
	{
		contentLength = endRange[1] + endRange[0] - startRange[0];
	}
	var content = getTextInRange(startPos, contentLength);
	var contentLines = content.split("\n");
	var replacedSpace = 0;
	var regex = /^    /;
	for (var i = 0; i < contentLines.length; i++)
	{
		var replaced = contentLines[i].search(regex) >= 0;
		if(replaced){
			contentLines[i] = contentLines[i].replace(regex, '');
			replacedSpace = replacedSpace + 4;
		}
	}
	var resultContent = contentLines.join("\n");
	setTextInRange(startPos, contentLength, resultContent);
	if (lnRange[1] > 0) {
		setSelectedRange(startPos, contentLength - replacedSpace);		
	}
	else
	{
		setSelectedRange(lnRange[0] - 4, 0);
	}
}


function moveRight()
{
	var lnRange = getSelectedRange();
	var startRange = getCurrentLine(lnRange[0]);
	var endRange = getCurrentLine(lnRange[0] + lnRange[1]);
	var startPos = startRange[0];
	var contentLength = 0;
	if (getTextInRange(endRange[1] + endRange[0] - 1, 1) == "\n")
	{
		contentLength = endRange[1] + endRange[0] - startRange[0] - 1;
	}
	else
	{
		contentLength = endRange[1] + endRange[0] - startRange[0];
	}
	var content = getTextInRange(startPos, contentLength);
	var contentLines = content.split("\n");
	var replacedSpace = 0;
	var regex = /^/;
	for (var i = 0; i < contentLines.length; i++)
	{
		var replaced = contentLines[i].search(regex) >= 0;
		if(replaced){
		    //newStr = newStr.replace(regex, '!');
			contentLines[i] = contentLines[i].replace(regex, '    ');
			replacedSpace = replacedSpace + 4;
		}
	}
	var resultContent = contentLines.join("\n");
	setTextInRange(startPos, contentLength, resultContent);
	if (lnRange[1] > 0) {
		setSelectedRange(startPos, contentLength + replacedSpace);		
	}
	else
	{
		setSelectedRange(lnRange[0] + 4, 0);
	}
}


function moveUp()
{
	var lnRange = getSelectedRange();
	var startRange = getCurrentLine(lnRange[0]);
	var endRange = getCurrentLine(lnRange[0] + lnRange[1]);
	var startPos = startRange[0];
	var currentLineStart = startRange[0];
	var currentLineLength = endRange[1] + endRange[0] - startRange[0];
    var cursorOffset = getSelectedRange()[0] - currentLineStart;
    if (currentLineStart != 0)
    {
        var startCharPos = currentLineStart - 2;
        while (getTextInRange(startCharPos, 1) != '\n' && startCharPos != 0)
        {
            startCharPos--;
        }
        if (startCharPos != 0)
        {
            startCharPos++;
        }
        var prevLineStart = startCharPos;
        var prevLineLength = currentLineStart - prevLineStart;
        var prevLineContent = getTextInRange(prevLineStart, prevLineLength);
        var currentLineContent = getTextInRange(currentLineStart, currentLineLength);
        if (!currentLineContent.endsWith('\n'))
        {
            currentLineContent = currentLineContent + '\n';
        }
        setTextInRange(prevLineStart, prevLineLength + currentLineLength, currentLineContent + prevLineContent);
        setSelectedRange(prevLineStart + cursorOffset, lnRange[1])
    }
}

function moveDown()
{
	var lnRange = getSelectedRange();
	var startRange = getCurrentLine(lnRange[0]);
	var endRange = getCurrentLine(lnRange[0] + lnRange[1]);
	var startPos = startRange[0];
	var currentLineStart = startRange[0];
	var currentLineLength = endRange[1] + endRange[0] - startRange[0];
    var cursorOffset = getSelectedRange()[0] - currentLineStart;
    var allTextLength = getText().length;
    if (currentLineStart + currentLineLength != allTextLength) // last line
    {
        var startCharPos = currentLineStart + currentLineLength;
        while (getTextInRange(startCharPos, 1) != '\n' && startCharPos != allTextLength)
        {
            startCharPos++;
        }
        if (startCharPos != 0)
        {
            startCharPos++;
        }
        var nextLineStart = currentLineStart + currentLineLength;
        var nextLineLength = startCharPos - nextLineStart;
        var nextLineContent = getTextInRange(nextLineStart, nextLineLength);
        var currentLineContent = getTextInRange(currentLineStart, currentLineLength);
        if (!nextLineContent.endsWith('\n'))
        {
            nextLineContent = nextLineContent + '\n'
        }
        setTextInRange(currentLineStart, currentLineLength + nextLineLength, nextLineContent + currentLineContent);
        setSelectedRange(currentLineStart + nextLineLength + cursorOffset, lnRange[1])
    }
}

function deleteElement()
{
    var cursor = getCursor();
    var currentLine = getCurrentLine(cursor);
    var currentLineText = getTextInRange(currentLine[0], currentLine[1]);
    if (!currentLineText.match(/^ *\* /))
    {
        var currentLine = getCurrentLine(cursor);
        setTextInRange(currentLine[0], currentLine[1], '');
        setSelectedRange(currentLine[0], 0);
    }
    else
    {
        var currentBlock = getCurrentBlock(cursor);
        setTextInRange(currentBlock[0], currentBlock[1], '');
        setSelectedRange(currentBlock[0], 0);
    }
}

function enterTwoSpaces()
{
    var currentLine = getSelectedLineRange();
    setTextInRange(currentLine[0] + currentLine[1] - 1, 0, '  ');
}

function enterNewLine()
{
    var currentLine = getSelectedLineRange();
    setTextInRange(currentLine[0] + currentLine[1], 0, '\n');
    setSelectedRange(currentLine[0] + currentLine[1], 0);
}

function toggleComment()
{
    var cursor = getCursor();
    var currentLine = getCurrentLine(cursor);
    var currentLineText = getTextInRange(currentLine[0], currentLine[1]);
    if (currentLineText.match(/^ *\* /))
    {
        var currentPoint = getCurrentPoint(cursor);
        var currentPointLine = getCurrentLine(currentPoint[0] + currentPoint[1] - 1);
        var currentPointLineText = getTextInRange(currentPointLine[0], currentPointLine[1]);
        if (currentPointLineText.match(/^ *\* /))
        {
            insertComment();
        }
        else
        {
            setSelectedRange(currentPoint[0] + currentPoint[1] - 1, 0);
        }
    }
    else
    {
        var found = false;
        var pos = cursor;
        var calls = 0;
        while (!found && !isFirstLine(pos) && !isEmptyLine(pos))
        {
            calls += 1;
            if (calls > maxCallCount)
            {
                alert("inf loop: toggleComment()");
                break;
            }
            var previousLine = getPreviousLine(pos);
            pos = previousLine[0];
            var posLineText = getTextInRange(previousLine[0], previousLine[1]);
            if (posLineText.match(/^ *\* /))
            {
                found = true;
            }
        }
        if (found){
            var currentPoint = getCurrentPoint(pos);
            var currentPointLine = getCurrentLine(currentPoint[0]);
            setSelectedRange(currentPointLine[0] + currentPointLine[1] - 1, 0);
        }
    }
}

function isEmptyLine(cursor)
{
    return getCurrentLine(cursor)[1] <= 1;
}

function insertComment()
{
    var currentLine = getSelectedLineRange();
    var currentLineText = getTextInRange(currentLine[0], currentLine[1]);
    var starPos = getStarPos(getCursor());
       var currentLineSpacePos = currentLineText.search(/[^ ]/);
    var result = "  \n";
    for (var i = 0; i < currentLineSpacePos; i++)
    {
        result += " ";
    }
    if (starPos >= 0)
    {
        result += "  ";
    }
    gotoEndOfLine();
    var cursor = getCursor();
       setTextInRange(cursor, 0, result);
    setSelectedRange(cursor + result.length, 0);
}

function bold()
{
    var currentRange = getSelectedRange();
    var text = getTextInRange(currentRange[0], currentRange[1]);
    if (getTextInRange(currentRange[0] - 2, 2) == '**' && getTextInRange(currentRange[0] + currentRange[1], 2) == '**')
    {
        setTextInRange(currentRange[0] - 2, currentRange[1] + 4, text);
        setSelectedRange(currentRange[0] - 2, currentRange[1]);
    }
    else
    {
        setTextInRange(currentRange[0], currentRange[1], '**' + text + '**');
        setSelectedRange(currentRange[0] + 2, currentRange[1]);
    }
}

function italic()
{
    var currentRange = getSelectedRange();
    var text = getTextInRange(currentRange[0], currentRange[1]);
    if (getTextInRange(currentRange[0] - 1, 1) == '*' && getTextInRange(currentRange[0] + currentRange[1], 1) == '*')
    {
        setTextInRange(currentRange[0] - 1, currentRange[1] + 2, text);
        setSelectedRange(currentRange[0] - 1, currentRange[1]);
    }
    else
    {
        setTextInRange(currentRange[0], currentRange[1], '*' + text + '*');
        setSelectedRange(currentRange[0] + 1, currentRange[1]);
    }
}

function insertURL()
{
    var currentRange = getSelectedRange();
    var text = getTextInRange(currentRange[0], currentRange[1]);
    if (currentRange[1] == 0)
    {
        setTextInRange(currentRange[0], currentRange[1], '[]()');
        setSelectedRange(currentRange[0] + 1, currentRange[1]);
    }
    else if (text.includes('://'))
    {
        setTextInRange(currentRange[0], currentRange[1], '[](' + text + ')');
        setSelectedRange(currentRange[0] + 1, 0);
    }
    else
    {
        setTextInRange(currentRange[0], currentRange[1], '[' + text + ']()');
        setSelectedRange(currentRange[0] + currentRange[1] + 3, 0);
    }
}

function insertPicture()
{
    var currentRange = getSelectedRange();
    var text = getTextInRange(currentRange[0], currentRange[1]);
    if (currentRange[1] == 0)
    {
        setTextInRange(currentRange[0], currentRange[1], '![]()');
        setSelectedRange(currentRange[0] + 2, currentRange[1]);
    }
    else if (text.includes('://'))
    {
        setTextInRange(currentRange[0], currentRange[1], '![](' + text + ')');
        setSelectedRange(currentRange[0] + 2, 0);
    }
    else
    {
        setTextInRange(currentRange[0], currentRange[1], '![' + text + ']()');
        setSelectedRange(currentRange[0] + currentRange[1] + 4, 0);
    }
}

function table()
{
    var alertTxt = '';

    // grab all content
    var text = '';
    var selectedRange = getSelectedRange();
    var selectedMode = (selectedRange[1] == 0);
    if (selectedMode)
    {
        text = getText();
    }
    else
    {
        text = getSelectedText();
    }

    // get max column number
    var lineData = text.split('\n')
        var rowNum = lineData.length;
    var colNum = 1;
    for (i = 0; i < rowNum; i++)
    {
        var currentLineColNum = lineData[i].split(' | ').length;
        if (currentLineColNum > colNum)
        {
            colNum = currentLineColNum;
        }
    }
    alertTxt = alertTxt + '\nColNum=' + colNum;

    // create data array[row][col] to place data, data[row][col]
    var data = new Array(rowNum);
    for (var i = 0; i < rowNum; i++)
    {
        data[i] = new Array(colNum);
    }

    // create array[col] to record column max length, maxLength[col]
    var colMaxLength = new Array(colNum);

    // create array[row] to record whether it should be tableize (boolean) shouldTableize[row]
    var shouldTableize = new Array(rowNum);

    // find whether the row should be tableize for each row and put to array[row]
    for (var i = 0; i < rowNum; i++)
    {
        if (lineData[i].split(' | ').length < colNum)
        {
            shouldTableize[i] = false;
        }
        else
        {
            shouldTableize[i] = true;
        }
        alertTxt = alertTxt + '\nRow ' + i + '=' + shouldTableize[i];
    }

    // put split data to the data array[row][col]
    for (var i = 0; i < rowNum; i++)
    {
        var colData = lineData[i].split(' | ');
        var colLength = colData.length;
        for (var j = 0; j < colLength; j++)
        {
            data[i][j] = colData[j].replace(/\s*$/,"");;
            alertTxt = alertTxt + '\n' + data[i][j];
        }
    }

    // calculate and put max length of column to array[col], need to skip array[row] = false
    for (var j = 0; j < colNum; j++)
    {
        eachColMaxLength = 0;
        for (var i = 0; i < rowNum; i++)
        {
            if (shouldTableize[i] && data[i][j] != undefined)
            {
                var dataLength = String(data[i][j]).length;
                alertTxt = alertTxt + '\n' + dataLength;
                if (dataLength > eachColMaxLength)
                {
                    eachColMaxLength = dataLength;
                }
            }
        }
        colMaxLength[j] = eachColMaxLength;
        alertTxt = alertTxt + '\nCol ' + j + '=' + colMaxLength[j];
    }


    // enrich spaces for each cell
    for (var i = 0; i < rowNum; i++)
    {
        if (shouldTableize[i])
        {
            for (var j = 0; j < colNum; j++)
            {
                var spaceNum = colMaxLength[j] - String(data[i][j]).length;
                for (var spaceCount = 0; spaceCount < spaceNum; spaceCount++)
                {
                    data[i][j] = data[i][j] + ' ';
                }
            }
        }
    }

    // join the array
    var finalLineData = new Array(rowNum);
    var isMarkdownTable = true;
    for(var i = 0; i < rowNum; i++)
    {
        if (shouldTableize[i])
        {
            finalLineData[i] = data[i].join(' | ');
            if (!finalLineData[i].startsWith(' | '))
            {
            	isMarkdownTable = false;
            }
        }
        else
        {
            finalLineData[i] = data[i][0];
        }
    }
    if (isMarkdownTable)
    {
	    for(var i = 0; i < rowNum; i++)
	    {
	        if (shouldTableize[i])
	        {
            	finalLineData[i] = finalLineData[i].substring(1, finalLineData[i].length-1);
	        }
	    }
    }
    var finalText = finalLineData.join('\n');


    // replace with selected data
    //alertTxt = alertTxt + '\n' + finalText;
    if (selectedMode)
    {
        setTextInRange(0, text.length, finalText);
    }
    else
    {
        setTextInRange(selectedRange[0], selectedRange[1], finalText);
        setSelectedRange(selectedRange[0], finalText.length);
    }
}


function test()
{
    var lnRange = getSelectedLineRange();
    var currentLine = getCurrentLine(lnRange[0]);

    alertTxt = 'lnRange=' + lnRange[0] + ',' + lnRange[1] + '\ncurrentLine=' +     currentLine[0] + ',' + currentLine[1];

    var starPosition = getStarPos(lnRange[0]);
    alertTxt = alertTxt + '\nstarPosition=' + starPosition;

    alertTxt = alertTxt + '\nisFirstLine=' + isFirstLine(currentLine[0]);
    alertTxt = alertTxt + '\nisLastLine=' + isLastLine(currentLine[0]);

    var previousLine = getPreviousLine(currentLine[0]);
    var nextLine = getNextLine(currentLine[0]);
    alertTxt = alertTxt + '\npreviousLine=' + previousLine[0] + ',' + previousLine[1];
    alertTxt = alertTxt + '\nnextLine=' + nextLine[0] + ',' + nextLine[1];

    var previousBlock = getPreviousBlock(currentLine[0]);
    alertTxt = alertTxt + '\nPreviousBlock=' + previousBlock[0] + ',' + previousBlock[1];

    var currentBlock = getCurrentBlock(currentLine[0]);
    alertTxt = alertTxt + '\nCurrentBlock=' + currentBlock[0] + ',' + currentBlock[1];

    var nextBlock = getNextBlock(currentLine[0]);
    alertTxt = alertTxt + '\nNextBlock=' + nextBlock[0] + ',' + nextBlock[1];

    alert(alertTxt);
}
    </script>
    
    <style>

@charset "utf-8";

div {
    font-family: Helvetica, Arial, Freesans, clean, sans-serif;
	padding:1em;
	margin:auto;
	max-width:42em;
}

p {
	line-height: 150%;
}

table {
    border-collapse: collapse;
}

th, td {
    text-align: left;
    padding-left: 8px;
    padding-right: 40px;
    padding-top: 8px;
    padding-bottom: 8px;
}

tr:nth-child(even) {
	background-color: #fbfbfb
}

h1, h2, h3, h4, h5, h6 {
    font-weight: bold;
}

h1 {
    color: #000000;
    font-size: 28px;
}

h2 {
    border-bottom: 1px solid #CCCCCC;
    color: #000000;
    font-size: 24px;
}

h3 {
    font-size: 18px;
}

h4 {
    font-size: 16px;
}

h5 {
    font-size: 14px;
}

h6 {
    color: #777777;
    background-color: inherit;
    font-size: 14px;
}

hr {
    height: 0.2em;
    border: 0;
    color: #CCCCCC;
    background-color: #CCCCCC;
}

p, blockquote, ul, ol, dl, li, table, pre {
    margin: 15px 0;
}

code, pre {
    border-radius: 3px;
    background-color: #F8F8F8;
    color: inherit;
}

code {
    border: 1px solid #EAEAEA;
    margin: 0 2px;
    padding: 0 5px;
}

pre {
    border: 1px solid #CCCCCC;
    line-height: 1.25em;
    overflow: auto;
    padding: 6px 10px;
}

pre > code {
    border: 0;
    margin: 0;
    padding: 0;
}

a, a:visited {
    color: #4183C4;
    background-color: inherit;
    text-decoration: none;
}

    </style>
</head>

<body>
    <textarea id="textarea" style="width:100%; height:100%;font-family: monospace;"></textarea>
    <div id="markdown"></div>
    <div id="console" hidden></div>
</body>
</html>
