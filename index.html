<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
    <title>RouOutliner</title>
    <script type="text/javascript">

var wd = "RouOutliner\n\n";
wd = wd + "Simplicity is the best.  \n";
wd = wd + "RouOutliner, a plain text outliner with only three features.  \n";
wd = wd + "Outliner, Table and Checklist.  \n";
wd = wd + "To Organize, to Clarify and to Action.  \n";
wd = wd + "\n";
wd = wd + "---\n";
wd = wd + "\n";
wd = wd + "* Why create this outliner?\n";
wd = wd + "    * I (@Roulesophy) am a Drafts4 and OmniOutliner heavy user in iOS.\n";
wd = wd + "    * I created some script in Drafts4's for outlining\n";
wd = wd + "    * Sometimes I am not using iPad I also need to do outlining\n";
wd = wd + "    * I really missed those functions I developed!\n";
wd = wd + "    * Therefore, RouOutliner is out :)\n";
wd = wd + "* Why plain text?\n";
wd = wd + "    * Plain text is the content which can stay for longest time\n";
wd = wd + "        * Needs specific program to open proprietary format\n";
wd = wd + "        * What if we cannot use them?\n";
wd = wd + "    * It is better to do version control\n";
wd = wd + "* How to use this outliner? (Ctrl-/ for more info)\n";
wd = wd + "    * Organising your idea:\n";
wd = wd + "        * Type all random thinkings in your mind here\n";
wd = wd + "        * Use our indend function to make hierarcy\n";
wd = wd + "            * Try Ctrl-H and Ctrl L here!\n";
wd = wd + "        * Use our reordering function to create sequence\n";
wd = wd + "            * Important thing comes first\n";
wd = wd + "            * Try Ctrl-J and Ctrl K here!\n";
wd = wd + "    * Convert the idea to action\n";
wd = wd + "            * Insert todo for points needed\n";
wd = wd + "            * Try Ctrl-O here! Press at least 5 times ;)\n";
wd = wd + "    * Use table to make your idea clear\n";
wd = wd + "        * Press Ctrl-\ to add column\n";
wd = wd + "        * It is hard to read the table format like the following\n";
wd = wd + "        * Try Ctrl-; here! It will format the table ;)\n";
wd = wd + "\n";
wd = wd + "\n";
wd = wd + " |  | Plain Text | proprietary format | \n";
wd = wd + " | --- | --- | --- | \n";
wd = wd + " | Outliner | RouOutliner | OmniOutliner | \n";
wd = wd + " | Text Editor | Vim | TextEdit | \n";

var tutorial = "";
tutorial = tutorial + "# Help file  \n";
tutorial = tutorial + "    \n";
tutorial = tutorial + "   Key                 | Feature                        \n";
tutorial = tutorial + "   ---                 | ---                            \n";
tutorial = tutorial + "* Outlining\n";
tutorial = tutorial + "    * Ctrl H           | Outdent a block                \n";
tutorial = tutorial + "    * Ctrl L           | Indent a block                 \n";
tutorial = tutorial + "    * Ctrl J           | Move down a block              \n";
tutorial = tutorial + "    * Ctrl K           | Move up a block                \n";
tutorial = tutorial + "    * Ctrl Shift J     | Move down a line               \n";
tutorial = tutorial + "    * Ctrl Shift K     | Move up a line                 \n";
tutorial = tutorial + "    * Ctrl D           | Delete                         \n";
tutorial = tutorial + "    * Ctrl E           | Empty line content             \n";
tutorial = tutorial + "    * Ctrl '           | Toggle comment                 \n";
tutorial = tutorial + "    * Ctrl R           | Find and replace               \n";
tutorial = tutorial + "    * Enter            | Enter next point               \n";
tutorial = tutorial + "    * Ctrl Enter       | Enter next sub point           \n";
tutorial = tutorial + "    * Ctrl Shift Enter | Enter point before             \n";
tutorial = tutorial + "* Todo List\n";
tutorial = tutorial + "    * Ctrl O           | Insert todo, toggle finish todo\n";
tutorial = tutorial + "* Table\n";
tutorial = tutorial + "    * Ctrl \           | Insert table column            \n";
tutorial = tutorial + "    * Ctrl ;           | Format table                   \n";
tutorial = tutorial + "* Markdown editing\n";
tutorial = tutorial + "    * Ctrl B           | Bold                           \n";
tutorial = tutorial + "    * Ctrl I           | Italic                         \n";
tutorial = tutorial + "    * Ctrl U           | Insert URL                     \n";
tutorial = tutorial + "    * Ctrl P           | Insert picture                 \n";
tutorial = tutorial + "* View\n";
tutorial = tutorial + "    * Ctrl =           | Increase font size             \n";
tutorial = tutorial + "    * Ctrl -           | Decrease font size             \n";
tutorial = tutorial + "* Navigation\n";
tutorial = tutorial + "    * Ctrl Shift 0-9   | Go to file 0-9                 \n";
tutorial = tutorial + "    * Ctrl Shift /     | Go to manual page              \n";
tutorial = tutorial + "    * Ctrl Shift ,     | Go to Index                    \n";
tutorial = tutorial + "    * Ctrl Shift .     | Go to homepage                 \n";
tutorial = tutorial + "\n";
tutorial = tutorial + "Now press Ctrl Shift <number> to your file...";

var fontSize = 14;

var maxCallCount = 999999;
var reg1 = '1';
var reg2 = '2';
var reg3 = '3';
var reg4 = '4';
var reg5 = '5';
var reg6 = '6';
var reg7 = '7';
var reg8 = '8';
var reg9 = '9';
var reg0 = '0';
var regTut = '?';
var regHome = '#';
var regIndex = '!';

var currentReg = reg1;

var textarea;
var localStorageKey = 'content';
window.onload = init;

// ------------------------------------------
// Rou Writer specific function

function init()
{
    textarea = document.getElementById("textarea");
    textarea.select();

	displayFontSize();

    getRegContent();

    textarea.addEventListener("keydown",function(e)
    {
        e = e || window.event;
        var key = e.which || e.keyCode; // keyCode detection
        var ctrl = e.ctrlKey ? e.ctrlKey : ((key === 17) ? true : false); // ctrl detection
        var alt = e.altKey ? e.altKey : ((key === 18) ? true : false); // alt detection
        var shift = e.shiftKey ? e.shiftKey : ((key === 16) ? true : false); // alt detection
        if (key == 72 && ctrl) // ctrl h
        {
            e.preventDefault();
            pushLeftBlock();
        }
        else if (key == 74 && ctrl && shift) // ctrl shift j
        {
            e.preventDefault();
            moveDown();
        }
        else if (key == 75 && ctrl && shift) // ctrl shift k
        {
            e.preventDefault();
            moveUp();
        }
        else if (key == 74 && ctrl) // ctrl j
        {
            e.preventDefault();
            pushDownBlock();
        }
        else if (key == 75 && ctrl) // ctrl k
        {
            e.preventDefault();
            pushUpBlock();
        }
        else if (key == 76 && ctrl) // ctrl l
        {
            e.preventDefault();
            pushRightBlock();
        }
        else if (key == 79 && ctrl) // ctrl o
        {
            e.preventDefault();
            handleCheckBox();
        }
        else if (key == 186 && ctrl) // ctrl ;
        {
            e.preventDefault();
            table();
        }
        else if (key == 68 && ctrl) // ctrl d
        {
            e.preventDefault();
            deleteElement();
        }
        else if (key == 222 && ctrl) // ctrl '
        {
            e.preventDefault();
            toggleComment();
        }
        else if (key == 66 && ctrl) // ctrl b
        {
            e.preventDefault();
            bold();
        }
        else if (key == 73 && ctrl) // ctrl i
        {
            e.preventDefault();
            italic();
        }
        else if (key == 85 && ctrl) // ctrl u
        {
            e.preventDefault();
            insertURL();
        }
        else if (key == 80 && ctrl) // ctrl p
        {
            e.preventDefault();
            insertPicture();
        }
        else if (key == 82 && ctrl) // ctrl r
        {
        	replace();
            e.preventDefault();
        }
        else if (key == 83 && ctrl) // ctrl s, disable save action
        {
            e.preventDefault();
        }
        else if (key == 220 && ctrl) // ctrl \
        {
        	insertTableDelimiter();
            e.preventDefault();
        }
        else if (key == 187 && ctrl) // ctrl =
        {
            e.preventDefault();
        	increaseFontSize();
        }
        else if (key == 189 && ctrl) // ctrl -
        {
            e.preventDefault();
        	decreaseFontSize();
        }
        else if (key == 69 && ctrl) // ctrl e
        {
            e.preventDefault();
            emptyLine();
        }
        else if (key == 49 && ctrl && shift) // ctrl 1
        {
            e.preventDefault();
            commitToLocalStorage();
            currentReg = reg1;
            getRegContent();
        }
        else if (key == 50 && ctrl && shift) // ctrl 2
        {
            e.preventDefault();
            commitToLocalStorage();
            currentReg = reg2;
            getRegContent();
        }
        else if (key == 51 && ctrl && shift) // ctrl 3
        {
            e.preventDefault();
            commitToLocalStorage();
            currentReg = reg3;
            getRegContent();
        }
        else if (key == 52 && ctrl && shift) // ctrl 4
        {
            e.preventDefault();
            commitToLocalStorage();
            currentReg = reg4;
            getRegContent();
        }
        else if (key == 53 && ctrl && shift) // ctrl 5
        {
            e.preventDefault();
            commitToLocalStorage();
            currentReg = reg5;
            getRegContent();
        }
        else if (key == 54 && ctrl && shift) // ctrl 6
        {
            e.preventDefault();
            commitToLocalStorage();
            currentReg = reg6;
            getRegContent();
        }
        else if (key == 55 && ctrl && shift) // ctrl 7
        {
            e.preventDefault();
            commitToLocalStorage();
            currentReg = reg7;
            getRegContent();
        }
        else if (key == 56 && ctrl && shift) // ctrl 8
        {
            e.preventDefault();
            commitToLocalStorage();
            currentReg = reg8;
            getRegContent();
        }
        else if (key == 57 && ctrl && shift) // ctrl 9
        {
            e.preventDefault();
            commitToLocalStorage();
            currentReg = reg9;
            getRegContent();
        }
        else if (key == 48 && ctrl && shift) // ctrl 0
        {
            e.preventDefault();
            commitToLocalStorage();
            currentReg = reg0;
            getRegContent();
        }
        else if (key == 191 && ctrl && shift) // ctrl ?
        {
            e.preventDefault();
            commitToLocalStorage();
            currentReg = regTut;
            getRegContent();
        }
        else if (key == 190 && ctrl && shift) // ctrl .
        {
            e.preventDefault();
            commitToLocalStorage();
            currentReg = regHome;
            getRegContent();
        }
        else if (key == 188 && ctrl && shift) // ctrl ,
        {
            e.preventDefault();
            commitToLocalStorage();
            currentReg = regIndex;
            getRegContent();
        }
        else if (key == 9 && shift) // shift tab
        {
            e.preventDefault();
            pushLeftBlock();
        }
        else if (key == 9) // tab
        {
            e.preventDefault();
            pushRightBlock();
        }
        else if (key == 13 && shift)
        {
            e.preventDefault();
            shiftEnterSpaceStarIfNeeded();
        }
        else if (key == 13 && ctrl)
        {
            e.preventDefault();
            enterSpaceStarIfNeededForSubPoint();
        }
        else if (key == 13) // enter
        {
            e.preventDefault();
            enterSpaceStarIfNeeded();
        }

        if (!(ctrl && key == 81)) // not ctrl Q
        {
            commitToLocalStorage();
            document.getElementById("console").innerHTML = localStorage.getItem(localStorageKey);
        }
        else
        {
            removeLocalStorage();
        }
    },false);

    textarea.addEventListener("keyup",function(e)
    {
        e = e || window.event;
        var key = e.which || e.keyCode; // keyCode detection
        var ctrl = e.ctrlKey ? e.ctrlKey : ((key === 17) ? true : false); // ctrl detection
        var shift = e.shiftKey ? e.shiftKey : ((key === 16) ? true : false); // alt detection
        if (key == 13 && ctrl) // ctrl + enter
        {
            e.preventDefault();
        }
        if (key == 13 && shift) // shift + enter
        {
            e.preventDefault();
        }
        else if (key == 13)
        {
            e.preventDefault();
            //enterSpaceStarIfNeeded();
        }
        getRegTitle();
    },false);
    setSelectedRange(0, 0);
}

function increaseFontSize()
{
	fontSize = fontSize + 2;
	displayFontSize();
}

function decreaseFontSize()
{
	fontSize = fontSize - 2;
	displayFontSize();
}

function displayFontSize()
{
	textarea.style.fontSize = fontSize + "px";
}

function getRegTitle()
{
    document.title = '[' + currentReg + '] ' + textarea.value.split('\n')[0];
}

function getTitleOfNotes(reg)
{
	var content = localStorage.getItem(reg);
	if (content == null)
	{
		return '';
	}
	else
	{
		return content.split('\n')[0];
	}
}

function getRegContent()
{
    var localStorageItem = localStorage.getItem(currentReg);
    document.getElementById("console").innerHTML = "#" + localStorageItem + "#";
    if (currentReg == regTut)
    {
        textarea.value = tutorial;
    }
    else if (currentReg == regHome)
    {
        textarea.value = wd;
    }
    else if (currentReg == regIndex)
    {
    	var content = 'Index:\n\n';
    	content = content + '* [' + reg1 + '] ' + getTitleOfNotes(reg1) + '\n';
    	content = content + '* [' + reg2 + '] ' + getTitleOfNotes(reg2) + '\n';
    	content = content + '* [' + reg3 + '] ' + getTitleOfNotes(reg3) + '\n';
    	content = content + '* [' + reg4 + '] ' + getTitleOfNotes(reg4) + '\n';
    	content = content + '* [' + reg5 + '] ' + getTitleOfNotes(reg5) + '\n';
    	content = content + '* [' + reg6 + '] ' + getTitleOfNotes(reg6) + '\n';
    	content = content + '* [' + reg7 + '] ' + getTitleOfNotes(reg7) + '\n';
    	content = content + '* [' + reg8 + '] ' + getTitleOfNotes(reg8) + '\n';
    	content = content + '* [' + reg9 + '] ' + getTitleOfNotes(reg9) + '\n';
    	content = content + '* [' + reg0 + '] ' + getTitleOfNotes(reg0);

    	textarea.value = content;
    }
    else if (localStorageItem != null)
    {
        textarea.value = localStorageItem;
    }
    else if (currentReg == reg1)
    {
        textarea.value = wd;
    }
    else
    {
        textarea.value = '';
    }
    getRegTitle();

    textarea.addEventListener("click", function()
    {
        var alertTxt = '';
        alertTxt += getCursor(textarea);
        alertTxt += '<br>' + getSurroundingSelection(textarea);
        document.getElementById("console").innerHTML = alertTxt;
    });
}

function commitToLocalStorage()
{
    localStorage.setItem(currentReg, textarea.value);
}

function removeLocalStorage()
{
    localStorage.removeItem(currentReg);
    textarea.blur();
    document.getElementById("console").innerHTML = localStorage.getItem(currentReg);
}


function emptyLine()
{
	var lnRange = getSelectedLineRange();
    var currentLineText = getTextInRange(lnRange[0], lnRange[1]);
    if (currentLineText.endsWith("\n"))
    {
    	setTextInRange(lnRange[0], lnRange[1], "\n");
    	setSelectedRange(lnRange[0], 0);
    }
    else
    {
        setTextInRange(lnRange[0], lnRange[1], "");
    	setSelectedRange(lnRange[0] + 1, 0);
    }
}

function gotoPreviousLine()
{
    var cursor = getCursor();
    if (isFirstLine(cursor))
    {
        return;
    }
    var previousLine = getPreviousLine(cursor);
    setSelectedRange(previousLine[0] + previousLine[1] - 1, 0);
}

function gotoEndOfLine()
{
    var lnRange = getSelectedLineRange();
    var currentLineText = getTextInRange(lnRange[0], lnRange[1]);
    if (currentLineText.endsWith('\n'))
    {
        setSelectedRange(lnRange[0] + lnRange[1] - 1, 0);
    }
    else
    {
        setSelectedRange(lnRange[0] + lnRange[1], 0);
    }
}

function shiftEnterSpaceStarIfNeeded()
{
    var cursor = getCursor();
    var lnRange = getCurrentLine(cursor);
    var currentLineText = getTextInRange(lnRange[0], lnRange[1]);
    if (currentLineText.match(/^ *\* /))
    {
        var currentLineStarPos = currentLineText.indexOf('* ');
        var result = "\n";
        for (var i = 0; i < currentLineStarPos; i++)
        {
            result += " ";
        }
        result += "* ";
        var cursor = lnRange[0];
        if (cursor == 0)
        {
            setTextInRange(cursor, 0, result);
            setSelectedRange(cursor + result.length, 0);
        }
        else
        {
            setTextInRange(cursor - 1, 0, result);
            setSelectedRange(cursor + result.length - 1, 0);
        }
    }
    else
    {
        var currentLineSpacePos = currentLineText.search(/[^ ]/);
        var result = "\n";
        for (var i = 0; i < currentLineSpacePos; i++)
        {
            result += " ";
        }
        var cursor = lnRange[0];
        if (cursor == 0)
        {
            setTextInRange(cursor, 0, result);
            setSelectedRange(cursor + result.length, 0);
        }
        else
        {
            setTextInRange(cursor - 1, 0, result);
            setSelectedRange(cursor + result.length - 1, 0);
        }
    }
}

function enterSpaceStarIfNeeded()
{
    //var lnRange = getCurrentLine(getCursor());
    var lnRange = getSelectedLineRange();
    var currentLineText = getTextInRange(lnRange[0], lnRange[1]);
    if (currentLineText.match(/^ *\* /))
    {
        gotoEndOfLine();
        var currentLineStarPos = currentLineText.indexOf('* ');

        var cursor = getCursor();
        var currentPoint = getCurrentPoint(cursor);
        var nextLine = getNextLine(currentPoint[0] + 1);
        if (nextLine == -1)
        {
            // next line is last line
        }
        else
        {
            var nextPointText = getTextInRange(nextLine[0], nextLine[1]);
            var nextPointTextStarPos = nextPointText.indexOf('* ');
            if (nextPointTextStarPos > currentLineStarPos)
            {
                currentLineStarPos = nextPointTextStarPos;
            }
        }

        //currentLineStarPos = currentLineText.indexOf('* ');
        var result = "\n";
        for (var i = 0; i < currentLineStarPos; i++)
        {
            result += " ";
        }
        result += "* ";


        if (isLastLine(cursor))
        {
            setTextInRange(currentPoint[0] + currentPoint[1], 0, result);
             setSelectedRange(currentPoint[0] + currentPoint[1] + result.length, 0);
        }
        else
        {
            setTextInRange(currentPoint[0] + currentPoint[1] - 1, 0, result);
            setSelectedRange(currentPoint[0] + currentPoint[1] - 1 + result.length, 0);
        }
    }
    else
    {
        // gotoEndOfLine();
        var currentLineSpacePos = currentLineText.search(/[^ ]/);
        var result = "";
        for (var i = 0; i < currentLineSpacePos; i++)
        {
            result += " ";
        }
        var cursor = getCursor();
        setTextInRange(cursor, 0, '  \n' + result);
        setSelectedRange(cursor + 3 + result.length, 0);
    }
}

function enterSpaceStarIfNeededForSubPoint()
{
    //var lnRange = getCurrentLine(getCursor());
    var lnRange = getSelectedLineRange();
    var currentLineText = getTextInRange(lnRange[0], lnRange[1]);
    if (currentLineText.match(/^ *\* /))
    {
        gotoEndOfLine();
        var currentLineStarPos = currentLineText.indexOf('* ');

        var cursor = getCursor();
        var currentPoint = getCurrentPoint(cursor);

        var result = "\n";
        for (var i = 0; i < currentLineStarPos + 4; i++)
        {
            result += " ";
        }
        result += "* ";


        if (isLastLine(cursor))
        {
            setTextInRange(currentPoint[0] + currentPoint[1], 0, result);
             setSelectedRange(currentPoint[0] + currentPoint[1] + result.length, 0);
        }
        else
        {
            setTextInRange(currentPoint[0] + currentPoint[1] - 1, 0, result);
            setSelectedRange(currentPoint[0] + currentPoint[1] - 1 + result.length, 0);
        }
    }
    else
    {
        gotoEndOfLine();
        var currentLineSpacePos = currentLineText.search(/[^ ]/);
        var result = "";
        for (var i = 0; i < currentLineSpacePos; i++)
        {
            result += " ";
        }
        var cursor = getCursor();
        setTextInRange(cursor, 0, '  \n' + result);
        setSelectedRange(cursor + 3 + result.length, 0);
    }
}

//------------------------------------------------------------------------------------------
// Drafts function

function getText()
{
    // returns the full text currently being edited
    return textarea.value;
}

function setText(string)
{
    // replaces full text being edited with string
    textarea.value = string;
}

function getSelectedText()
{
    // return only the selected text. If no text selection exists, this will return an empty string.
    return getMiddleCursorSelection();
}

function setSelectedText(string)
{
    // Replace only the current selected text range with the string. Also updates the selected range to match any change in length of the new string.
    textarea.value = getBeforeCursorSelection() + string + getAfterCursorSelection();
}

function getTextInRange(start, length)
{

    // Return text in the request range.
    return textarea.value.substring(start, start + length);
}

function setTextInRange(start, length, string)
{
    // Replace the text in the specified range with the value of string.
    var text = string;

    // method 1
    //textarea.value = textarea.value.substring(0, start) + string + textarea.value.substring(start + length, textarea.value.length);

    // method 2
    setSelectedRange(start, length);
    document.execCommand('insertText', false, text);

    // method 3
    //var event = document.createEvent('TextEvent');
    //setSelectedRange(start, length);
    //event.initTextEvent('textInput', true, true, null, text || "\0");
    //textarea.dispatchEvent(event); // fire the event on the the textarea
}
function getSelectedLineRange()
{
    // Returns the range (start,length) of the full line based on the current cursor position
    return getCurrentLine(getCursor());
}
function getSelectedRange()
{
    // Returns the current selected text range as an array with values [start, length].
    var result = new Array();
    result[0] = textarea.selectionStart;
    result[1] = textarea.selectionEnd - textarea.selectionStart;
    return result;
}
function setSelectedRange(start, length)
{
    // Set the selected range of text. Invalid ranges will be automatically adjusted, and this text selection will be applied after successful completion of the script.
    setSelectionRange(start, start + length);
}
function getClipboard()
{
    // Returns current contents of the system clipboard.
    // Not supported yet
}
function setClipboard(string)
{

    // Set the system clipboard to the string passed.
    // Not supported yet
}
function markdown(string, useXHTML)
{

    // runs the string through the Markdown processor returning HTML.
    // Not supported yet
}
function encodeHTMLEntities(string)
{
    // Encodes the string to HTML safe entities, e.g. converting & to &amp;
    // Not supported yet
}
function decodeHTMLEntities(string)
{
    //Decodes HTML entities.
    // Not supported yet
}

//---------------------------------------------------------------------------------------------------
// Drafts adapter function

function setSelectionRange(selectionStart, selectionEnd)
{
    if (textarea.setSelectionRange)
    {
        textarea.focus();
        textarea.setSelectionRange(selectionStart, selectionEnd);
    }
    else if (textarea.createTextRange)
    {
        var range = textarea.createTextRange();
        range.collapse(true);
        range.moveEnd('character', selectionEnd);
        range.moveStart('character', selectionStart);
        range.select();
    }
}

function setCaretToPos(pos)
{
    setSelectionRange(pos, pos);
}

function getSurroundingSelection()
{
    return [textarea.value.substring(0, textarea.selectionStart)
        ,textarea.value.substring(textarea.selectionStart, textarea.selectionEnd)
        ,textarea.value.substring(textarea.selectionEnd, textarea.value.length)]
}
function getBeforeCursorSelection()
{
    return textarea.value.substring(0, textarea.selectionStart);
}
function getMiddleCursorSelection()
{
    return textarea.value.substring(textarea.selectionStart, textarea.selectionEnd);
}
function getAfterCursorSelection()
{
    return textarea.value.substring(textarea.selectionEnd, textarea.value.length);
}

//-------------------------------------------------------------------------------------------------
// Self function
function replace()
{
	var reStr = prompt("Please enter find with words", "");
	if (reStr == null ||reStr == "")
	{
		return;
	}
	var re = new RegExp(reStr, "g");
	var replaceStr = prompt("Please enter word to replace '" + reStr + "'", "");
	var text = getText();
	if (replaceStr == null)
	{
		return;
	}
	setTextInRange(0, text.length, text.replace(re, replaceStr));
}

function getCursor()
{
    return getSelectedRange()[0];
}

function insertTableDelimiter()
{
	setTextInRange(getCursor(), 0, ' | ');
}

function getCurrentLine(startCharPos)
{
    var startPos;
    var length = 0;
    if (startCharPos == 0)
    {
        startPos = startCharPos;
    }
    else
    {
        startPos = startCharPos;
        var calls = 0;
        while (startPos > 0 && getTextInRange(startPos - 1, 1) != '\n')
        {
            calls += 1;
            if (calls > maxCallCount)
            {
                alert("inf loop: getCurrentLine()");
                break;
            }
            startPos--;
        }
    }
    var tempPos = startPos;
    var allTextLength = getText().length;
    var calls = 0;
    while (tempPos < allTextLength && getTextInRange(tempPos, 1) != '\n')
    {
        calls += 1;
        if (calls > maxCallCount)
        {
            alert("inf loop: getCurrentLine()");
            break;
        }
        tempPos++;
        length++;
    }
    if (tempPos != allTextLength)
    {
        length++;
    }
    var result = new Array();
    result[0] = startPos;
    result[1] = length;
    return result;
}

function getStarPos(cursor)
{
    var lnRange = getCurrentLine(cursor);
    var text = getTextInRange(lnRange[0], lnRange[1]);
    if (text.match(/^ *\* /))
    {
        var starLength = 0;
        var startPos = lnRange[0];
        var calls = 0;
        while (getTextInRange(startPos, 1) != '*')
        {
            calls += 1;
            if (calls > maxCallCount)
            {
                alert("inf loop: getStarPos()");
                break;
            }
            startPos++;
            starLength++;
        }
        return starLength;
    }
    return -1;
}

function cursorPos(cursor)
{
    return cursor - getCurrentLine(cursor)[0];
}

function currentCursorPos()
{
    return getSelectedRange()[0] - getSelectedLineRange()[0];
}

function isFirstLine(cursor)
{
    return getCurrentLine(cursor)[0] == 0;
}

function isLastLine(cursor)
{
    var lnRange = getCurrentLine(cursor);
    return lnRange[0] + lnRange[1] == getText().length;
}

function getPreviousLine(cursor)
{
    if (isFirstLine(cursor))
    {
        return -1;
    }
    else
    {
        var pos = getCurrentLine(cursor)[0] - 1;
        return getCurrentLine(pos);
    }
}

function getNextLine(cursor)
{
    if (isLastLine(cursor))
    {
        return -1;
    }
    else
    {
        var lnRange = getCurrentLine(cursor);
        var pos = lnRange[0] + lnRange[1];
        return getCurrentLine(pos);
    }
}

function getPreviousBlock(cursor)
{
    var starPos = getStarPos(cursor);
    var currentLine = getCurrentLine(cursor);
    if (starPos == -1)
    {
        return -1;
    }
    var startPos = currentLine[0];
    var starPosCurrentLine = getStarPos(currentLine[0]);
    var found = false;
    var previousBlockPos = -1;
    var calls = 0;
    while (!found && !isFirstLine(startPos))
    {
        calls += 1;
        if (calls > maxCallCount)
        {
            alert("inf loop: getPreviousBlock()");
            break;
        }
        var previousLine = getPreviousLine(startPos);
        startPos = previousLine[0];
        if (previousLine[1] == 1) // empty line
        {
            break;
        }
        if (getStarPos(startPos) == starPosCurrentLine)
        {
            found = true;
            previousBlockPos = startPos;
        }
    }
    if (found)
    {
        var previousBlock = new Array();
        previousBlock[0] = previousBlockPos;
        previousBlock[1] = currentLine[0] - previousBlockPos;
        return previousBlock;
    }
    else
    {
        return -1;
    }
}

// at star line use, get current point with comment
function getCurrentPoint(cursor)
{
    var starPos = getStarPos(cursor);
    var currentLine = getCurrentLine(cursor);
    if (starPos == -1)
    {
        return -1;
    }
    if (isLastLine(cursor))
    {
        return currentLine;
    }
    var startPos = currentLine[0];
    var found = false;
    var calls = 0;
    while(!found && !isLastLine(startPos))
    {
        calls += 1;
        if (calls > maxCallCount)
        {
            alert("inf loop: getCurrentPoint()");
            break;
        }
        var nextLine = getNextLine(startPos);
        startPos = nextLine[0];
        if (nextLine[1] == 1) // empty line
        {
            startPos = getCurrentLine(startPos - 1)[0];
            break;
        }
        var currentStarPos = getStarPos(startPos);
        if (currentStarPos >= 0)
        {
            found = true;
        }
    }
    if (found)
    {
        startPos = getPreviousLine(startPos)[0];
        var result = new Array();
        result[0] = currentLine[0];
        result[1] = startPos + getCurrentLine(startPos)[1] - currentLine[0];
        return result;
    }
    else
    {
        var result = new Array();
        result[0] = currentLine[0];
        result[1] = startPos + getCurrentLine(startPos)[1] - currentLine[0];
        return result;
    }
}

function getCurrentBlock(cursor)
{
    var starPos = getStarPos(cursor);
    var currentLine = getCurrentLine(cursor);
    if (starPos == -1)
    {
        return -1;
    }
    if (isLastLine(cursor))
    {
        return currentLine;
    }
    var startPos = currentLine[0];
    var found = false;
    var calls = 0;
    while(!found && !isLastLine(startPos))
    {
        calls += 1;
        if (calls > maxCallCount)
        {
            alert("inf loop: getCurrentBlock()");
            break;
        }
        var nextLine = getNextLine(startPos);
        startPos = nextLine[0];
        if (nextLine[1] == 1) // empty line
        {
            startPos = getCurrentLine(startPos - 1)[0];
            break;
        }
        var currentStarPos = getStarPos(startPos);
        if (currentStarPos >= 0 && currentStarPos <= starPos)
        {
            found = true;
        }
    }
    if (found)
    {
        startPos = getPreviousLine(startPos)[0];
        var result = new Array();
        result[0] = currentLine[0];
        result[1] = startPos + getCurrentLine(startPos)[1] - currentLine[0];
        return result;
    }
    else
    {
        var result = new Array();
        result[0] = currentLine[0];
        result[1] = startPos + getCurrentLine(startPos)[1] - currentLine[0];
        return result;
    }
}

function getNextBlock(cursor)
{
    var starPos = getStarPos(cursor);
    var currentLine = getCurrentLine(cursor);
    if (starPos == -1)
    {
        return -1;
    }
    if (isLastLine(cursor))
    {
        return -1;
    }
    var startPos = currentLine[0];
    var found = false;
    var calls = 0;
    while(!found && !isLastLine(startPos))
    {
        calls += 1;
        if (calls > maxCallCount)
        {
            alert("inf loop: getNextBlock()");
            break;
        }
        var nextLine = getNextLine(startPos);
        startPos = nextLine[0];
        var currentStarPos = getStarPos(startPos);
        if (nextLine[1] == 1) // empty line
        {
            return -1;
        }
        if (currentStarPos >= 0 && currentStarPos < starPos)
        {
            return -1;
        }
        if (currentStarPos == starPos)
        {
            return getCurrentBlock(startPos);
        }
    }
    return -1;
}

function pushDownBlock()
{
    var currentCursorWidth = currentCursorPos();
    var cursor = getSelectedLineRange()[0];
    var currentBlock = getCurrentBlock(cursor);
    var nextBlock = getNextBlock(cursor);
    if (currentBlock == -1 || nextBlock == -1)
    {
        return;
    }
    var currentBlockContent = getTextInRange(currentBlock[0], currentBlock[1]);
    var nextBlockContent = getTextInRange(nextBlock[0], nextBlock[1]);
    if (!nextBlockContent.endsWith('\n'))
    {
        nextBlockContent = nextBlockContent + '\n';
    }
    setTextInRange(cursor, currentBlock[1] + nextBlock[1], nextBlockContent + currentBlockContent);
    setSelectedRange(cursor + nextBlockContent.length + currentCursorWidth, 0);
}

function pushUpBlock()
{
    var currentCursorWidth = currentCursorPos();
    var cursor = getSelectedLineRange()[0];
    var currentBlock = getCurrentBlock(cursor);
    var previousBlock = getPreviousBlock(cursor);
    if (currentBlock == -1 || previousBlock == -1)
    {
        return;
    }
    var currentBlockContent = getTextInRange(currentBlock[0], currentBlock[1]);
    var previousBlockContent = getTextInRange(previousBlock[0], previousBlock[1]);
    if (!currentBlockContent.endsWith('\n'))
    {
        currentBlockContent = currentBlockContent + '\n';
    }
    setTextInRange(previousBlock[0], previousBlock[1] + currentBlock[1], currentBlockContent + previousBlockContent);
    setSelectedRange(previousBlock[0] + currentCursorWidth, 0);
}

function indentBlock(text)
{
    var endsWithNewLine = text.endsWith('\n');
    if (endsWithNewLine)
    {
        text = text.substring(0, text.length - 1);
    }
    var lines = text.split('\n');
    for (var i = 0; i < lines.length; i++)
    {
        lines[i] = lines[i].replace(/^/, '    ');
    }
    var result = lines.join('\n');
    if (endsWithNewLine)
    {
        result = result + '\n';
    }
    return result;
}

function outdentBlock(text)
{
    var endsWithNewLine = text.endsWith('\n');
    if (endsWithNewLine)
    {
        text = text.substring(0, text.length - 1);
    }
    var lines = text.split('\n');
    for (var i = 0; i < lines.length; i++)
    {
        lines[i] = lines[i].replace(/^    /, '');
    }
    var result = lines.join('\n');
    if (endsWithNewLine)
    {
        result = result + '\n';
    }
    return result;
}

function pushRightBlock()
{
    var lnRange = getSelectedLineRange();
    var currentLine = getTextInRange(lnRange[0], lnRange[1]);
    if (!currentLine.match(/ *\*/))
    {
        moveRight();
    }
    else
    {
        var currentCursorWidth = currentCursorPos();
        var cursor = getSelectedLineRange()[0];
        var currentBlock = getCurrentBlock(cursor);
        var currentBlockContent = getTextInRange(currentBlock[0], currentBlock[1]);
        var replacedContent = indentBlock(currentBlockContent);
        setTextInRange(currentBlock[0], currentBlock[1], replacedContent);
        setSelectedRange(currentBlock[0] + currentCursorWidth + 4, 0);
    }
}


function pushLeftBlock()
{
    var lnRange = getSelectedLineRange();
    var currentLine = getTextInRange(lnRange[0], lnRange[1]);
    if (!currentLine.startsWith('    '))
    {
        return;
    }
    if (!currentLine.match(/ *\*/))
    {
        moveLeft();
    }
    else
    {
        var currentCursorWidth = currentCursorPos();
        var cursor = getSelectedLineRange()[0];
        var currentBlock = getCurrentBlock(cursor);
        var currentBlockContent = getTextInRange(currentBlock[0], currentBlock[1]);
        var replacedContent = outdentBlock(currentBlockContent);
        setTextInRange(currentBlock[0], currentBlock[1], replacedContent);
        var minusCursor = 0;
        if (currentCursorWidth - 4 > 0)
        {
            minusCursor = currentCursorWidth - 4;
        }
        setSelectedRange(currentBlock[0] + minusCursor, 0);
    }
}

function checkBoxExists(cursor)
{
    var currentLine = getCurrentLine(cursor);
    var currentLineText = getTextInRange(currentLine[0], currentLine[1]);
    if (currentLineText.match(/\* \[ \] /))
    {
        return true;
    }
    else if (currentLineText.match(/\* \[x\] /))
    {
        return true;
    }
    else
    {
        return false;
    }
}

function checkBoxIsChecked(cursor)
{
    var currentLine = getCurrentLine(cursor);
    var currentLineText = getTextInRange(currentLine[0], currentLine[1]);
    if (currentLineText.match(/\* \[x\] /))
    {
        return true;
    }
    else
    {
        return false;
    }
}

function checkBoxIsNotChecked(cursor)
{
    var currentLine = getCurrentLine(cursor);
    var currentLineText = getTextInRange(currentLine[0], currentLine[1]);
    if (currentLineText.match(/\* \[ \] /))
    {
        return true;
    }
    else
    {
        return false;
    }
}

function insertCheckBox(cursor)
{
    if (getStarPos(cursor) == -1)
    {
        return;
    }
    var currentLine = getCurrentLine(cursor);
    var currentRange = getSelectedRange();
    var currentLineText = getTextInRange(currentLine[0], currentLine[1]);
    var checkBox = currentLineText.replace(/\* /, '* \[ \] ');
    setTextInRange(currentLine[0], currentLine[1], checkBox);
    setSelectedRange(currentRange[0] + 4, 0);
}

function toggleCheckBox(cursor)
{
    var currentLine = getCurrentLine(cursor);
    var currentLineText = getTextInRange(currentLine[0], currentLine[1]);
    var notChecked = /\* \[ \] /;
    var checked = /\* \[x\] /;
    if (currentLineText.match(notChecked))
    {
        currentLineText = currentLineText.replace(notChecked, '* [x] ');
        setTextInRange(currentLine[0], currentLine[1], currentLineText);
        setSelectedRange(cursor, 0);
    }
    else if (currentLineText.match(checked))
    {
        currentLineText = currentLineText.replace(checked, '* [ ] ');
        setTextInRange(currentLine[0], currentLine[1], currentLineText);
        setSelectedRange(cursor, 0);
    }
}

function handleCheckBox()
{
    var cursor = getCursor();
    if (checkBoxExists(cursor))
    {
        toggleCheckBox(cursor);
    }
    else
    {
        insertCheckBox(cursor);
    }
}

function moveLeft()
{
    var lnRange = getSelectedLineRange();
    var currentLineStart = lnRange[0];
    var currentLineLength = lnRange[1];
    var currentCursorPos = getSelectedRange()[0];

    var currentLineContent = getTextInRange(currentLineStart, currentLineLength);
    currentLineContent = currentLineContent.replace(/^    /, '');

    setTextInRange(currentLineStart, currentLineLength, currentLineContent);
    setSelectedRange(currentCursorPos - 4, 0);
}


function moveRight()
{
    var lnRange = getSelectedLineRange();
    var currentLineStart = lnRange[0];
    var currentLineLength = lnRange[1];
    var currentCursorPos = getSelectedRange()[0];

    var currentLineContent = getTextInRange(currentLineStart, currentLineLength);
    currentLineContent = currentLineContent.replace(/^/, '    ');

    setTextInRange(currentLineStart, currentLineLength, currentLineContent);
    setSelectedRange(currentCursorPos + 4, 0);
}


function moveUp()
{
    var lnRange = getSelectedLineRange();
    var currentLineStart = lnRange[0];
    var currentLineLength = lnRange[1];
    var cursorOffset = getSelectedRange()[0] - currentLineStart;

    if (currentLineStart != 0)
    {
        var startCharPos = currentLineStart - 2;
        while (getTextInRange(startCharPos, 1) != '\n' && startCharPos != 0)
        {
            startCharPos--;
        }
        if (startCharPos != 0)
        {
            startCharPos++;
        }
        var prevLineStart = startCharPos;
        var prevLineLength = currentLineStart - prevLineStart;
        var prevLineContent = getTextInRange(prevLineStart, prevLineLength);
        var currentLineContent = getTextInRange(currentLineStart, currentLineLength);
        if (!currentLineContent.endsWith('\n'))
        {
            currentLineContent = currentLineContent + '\n';
        }
        setTextInRange(prevLineStart, prevLineLength + currentLineLength, currentLineContent + prevLineContent);
        setSelectedRange(prevLineStart + cursorOffset,0)
    }
}

function moveDown()
{
    var lnRange = getSelectedLineRange();
    var currentLineStart = lnRange[0];
    var currentLineLength = lnRange[1];

    var cursorOffset = getSelectedRange()[0] - currentLineStart;
    var allTextLength = getText().length;
    if (currentLineStart + currentLineLength != allTextLength) // last line
    {
        var startCharPos = currentLineStart + currentLineLength;
        while (getTextInRange(startCharPos, 1) != '\n' && startCharPos != allTextLength)
        {
            startCharPos++;
        }
        if (startCharPos != 0)
        {
            startCharPos++;
        }
        var nextLineStart = currentLineStart + currentLineLength;
        var nextLineLength = startCharPos - nextLineStart;
        var nextLineContent = getTextInRange(nextLineStart, nextLineLength);
        var currentLineContent = getTextInRange(currentLineStart, currentLineLength);
        if (!nextLineContent.endsWith('\n'))
        {
            nextLineContent = nextLineContent + '\n'
        }
        setTextInRange(currentLineStart, currentLineLength + nextLineLength, nextLineContent + currentLineContent);
        setSelectedRange(currentLineStart + nextLineLength + cursorOffset, 0)
    }
}

function deleteElement()
{
    var cursor = getCursor();
    var currentLine = getCurrentLine(cursor);
    var currentLineText = getTextInRange(currentLine[0], currentLine[1]);
    if (!currentLineText.match(/^ *\* /))
    {
        var currentLine = getCurrentLine(cursor);
        setTextInRange(currentLine[0], currentLine[1], '');
        setSelectedRange(currentLine[0], 0);
    }
    else
    {
        var currentBlock = getCurrentBlock(cursor);
        setTextInRange(currentBlock[0], currentBlock[1], '');
        setSelectedRange(currentBlock[0], 0);
    }
}

function enterTwoSpaces()
{
    var currentLine = getSelectedLineRange();
    setTextInRange(currentLine[0] + currentLine[1] - 1, 0, '  ');
}

function enterNewLine()
{
    var currentLine = getSelectedLineRange();
    setTextInRange(currentLine[0] + currentLine[1], 0, '\n');
    setSelectedRange(currentLine[0] + currentLine[1], 0);
}

function toggleComment()
{
    var cursor = getCursor();
    var currentLine = getCurrentLine(cursor);
    var currentLineText = getTextInRange(currentLine[0], currentLine[1]);
    if (currentLineText.match(/^ *\* /))
    {
        var currentPoint = getCurrentPoint(cursor);
        var currentPointLine = getCurrentLine(currentPoint[0] + currentPoint[1] - 1);
        var currentPointLineText = getTextInRange(currentPointLine[0], currentPointLine[1]);
        if (currentPointLineText.match(/^ *\* /))
        {
            insertComment();
        }
        else
        {
            setSelectedRange(currentPoint[0] + currentPoint[1] - 1, 0);
        }
    }
    else
    {
        var found = false;
        var pos = cursor;
        var calls = 0;
        while (!found && !isFirstLine(pos) && !isEmptyLine(pos))
        {
            calls += 1;
            if (calls > maxCallCount)
            {
                alert("inf loop: toggleComment()");
                break;
            }
            var previousLine = getPreviousLine(pos);
            pos = previousLine[0];
            var posLineText = getTextInRange(previousLine[0], previousLine[1]);
            if (posLineText.match(/^ *\* /))
            {
                found = true;
            }
        }
        if (found){
            var currentPoint = getCurrentPoint(pos);
            var currentPointLine = getCurrentLine(currentPoint[0]);
            setSelectedRange(currentPointLine[0] + currentPointLine[1] - 1, 0);
        }
    }
}

function isEmptyLine(cursor)
{
    return getCurrentLine(cursor)[1] <= 1;
}

function insertComment()
{
    var currentLine = getSelectedLineRange();
    var currentLineText = getTextInRange(currentLine[0], currentLine[1]);
    var starPos = getStarPos(getCursor());
       var currentLineSpacePos = currentLineText.search(/[^ ]/);
    var result = "  \n";
    for (var i = 0; i < currentLineSpacePos; i++)
    {
        result += " ";
    }
    if (starPos >= 0)
    {
        result += "  ";
    }
    gotoEndOfLine();
    var cursor = getCursor();
       setTextInRange(cursor, 0, result);
    setSelectedRange(cursor + result.length, 0);
}

function bold()
{
    var currentRange = getSelectedRange();
    var text = getTextInRange(currentRange[0], currentRange[1]);
    if (getTextInRange(currentRange[0] - 2, 2) == '**' && getTextInRange(currentRange[0] + currentRange[1], 2) == '**')
    {
        setTextInRange(currentRange[0] - 2, currentRange[1] + 4, text);
        setSelectedRange(currentRange[0] - 2, currentRange[1]);
    }
    else
    {
        setTextInRange(currentRange[0], currentRange[1], '**' + text + '**');
        setSelectedRange(currentRange[0] + 2, currentRange[1]);
    }
}

function italic()
{
    var currentRange = getSelectedRange();
    var text = getTextInRange(currentRange[0], currentRange[1]);
    if (getTextInRange(currentRange[0] - 1, 1) == '*' && getTextInRange(currentRange[0] + currentRange[1], 1) == '*')
    {
        setTextInRange(currentRange[0] - 1, currentRange[1] + 2, text);
        setSelectedRange(currentRange[0] - 1, currentRange[1]);
    }
    else
    {
        setTextInRange(currentRange[0], currentRange[1], '*' + text + '*');
        setSelectedRange(currentRange[0] + 1, currentRange[1]);
    }
}

function insertURL()
{
    var currentRange = getSelectedRange();
    var text = getTextInRange(currentRange[0], currentRange[1]);
    if (currentRange[1] == 0)
    {
        setTextInRange(currentRange[0], currentRange[1], '[]()');
        setSelectedRange(currentRange[0] + 1, currentRange[1]);
    }
    else if (text.includes('://'))
    {
        setTextInRange(currentRange[0], currentRange[1], '[](' + text + ')');
        setSelectedRange(currentRange[0] + 1, 0);
    }
    else
    {
        setTextInRange(currentRange[0], currentRange[1], '[' + text + ']()');
        setSelectedRange(currentRange[0] + currentRange[1] + 3, 0);
    }
}

function insertPicture()
{
    var currentRange = getSelectedRange();
    var text = getTextInRange(currentRange[0], currentRange[1]);
    if (currentRange[1] == 0)
    {
        setTextInRange(currentRange[0], currentRange[1], '![]()');
        setSelectedRange(currentRange[0] + 2, currentRange[1]);
    }
    else if (text.includes('://'))
    {
        setTextInRange(currentRange[0], currentRange[1], '![](' + text + ')');
        setSelectedRange(currentRange[0] + 2, 0);
    }
    else
    {
        setTextInRange(currentRange[0], currentRange[1], '![' + text + ']()');
        setSelectedRange(currentRange[0] + currentRange[1] + 4, 0);
    }
}

function table()
{
    var alertTxt = '';

    // grab all content
    var text = '';
    var selectedRange = getSelectedRange();
    var selectedMode = (selectedRange[1] == 0);
    if (selectedMode)
    {
        text = getText();
    }
    else
    {
        text = getSelectedText();
    }

    // get max column number
    var lineData = text.split('\n')
        var rowNum = lineData.length;
    var colNum = 1;
    for (i = 0; i < rowNum; i++)
    {
        var currentLineColNum = lineData[i].split(' | ').length;
        if (currentLineColNum > colNum)
        {
            colNum = currentLineColNum;
        }
    }
    alertTxt = alertTxt + '\nColNum=' + colNum;

    // create data array[row][col] to place data, data[row][col]
    var data = new Array(rowNum);
    for (var i = 0; i < rowNum; i++)
    {
        data[i] = new Array(colNum);
    }

    // create array[col] to record column max length, maxLength[col]
    var colMaxLength = new Array(colNum);

    // create array[row] to record whether it should be tableize (boolean) shouldTableize[row]
    var shouldTableize = new Array(rowNum);

    // find whether the row should be tableize for each row and put to array[row]
    for (var i = 0; i < rowNum; i++)
    {
        if (lineData[i].split(' | ').length < colNum)
        {
            shouldTableize[i] = false;
        }
        else
        {
            shouldTableize[i] = true;
        }
        alertTxt = alertTxt + '\nRow ' + i + '=' + shouldTableize[i];
    }

    // put split data to the data array[row][col]
    for (var i = 0; i < rowNum; i++)
    {
        var colData = lineData[i].split(' | ');
        var colLength = colData.length;
        for (var j = 0; j < colLength; j++)
        {
            data[i][j] = colData[j].replace(/\s*$/,"");;
            alertTxt = alertTxt + '\n' + data[i][j];
        }
    }

    // calculate and put max length of column to array[col], need to skip array[row] = false
    for (var j = 0; j < colNum; j++)
    {
        eachColMaxLength = 0;
        for (var i = 0; i < rowNum; i++)
        {
            if (shouldTableize[i] && data[i][j] != undefined)
            {
                var dataLength = String(data[i][j]).length;
                alertTxt = alertTxt + '\n' + dataLength;
                if (dataLength > eachColMaxLength)
                {
                    eachColMaxLength = dataLength;
                }
            }
        }
        colMaxLength[j] = eachColMaxLength;
        alertTxt = alertTxt + '\nCol ' + j + '=' + colMaxLength[j];
    }


    // enrich spaces for each cell
    for (var i = 0; i < rowNum; i++)
    {
        if (shouldTableize[i])
        {
            for (var j = 0; j < colNum; j++)
            {
                var spaceNum = colMaxLength[j] - String(data[i][j]).length;
                for (var spaceCount = 0; spaceCount < spaceNum; spaceCount++)
                {
                    data[i][j] = data[i][j] + ' ';
                }
            }
        }
    }

    // join the array
    var finalLineData = new Array(rowNum);
    for(var i = 0; i < rowNum; i++)
    {
        if (shouldTableize[i])
        {
            finalLineData[i] = data[i].join(' | ');
        }
        else
        {
            finalLineData[i] = data[i][0];
        }
    }
    var finalText = finalLineData.join('\n');


    // replace with selected data
    //alertTxt = alertTxt + '\n' + finalText;
    if (selectedMode)
    {
        setTextInRange(0, text.length, finalText);
    }
    else
    {
        setTextInRange(selectedRange[0], selectedRange[1], finalText);
        setSelectedRange(selectedRange[0], finalText.length);
    }
}


function test()
{
    var lnRange = getSelectedLineRange();
    var currentLine = getCurrentLine(lnRange[0]);

    alertTxt = 'lnRange=' + lnRange[0] + ',' + lnRange[1] + '\ncurrentLine=' +     currentLine[0] + ',' + currentLine[1];

    var starPosition = getStarPos(lnRange[0]);
    alertTxt = alertTxt + '\nstarPosition=' + starPosition;

    alertTxt = alertTxt + '\nisFirstLine=' + isFirstLine(currentLine[0]);
    alertTxt = alertTxt + '\nisLastLine=' + isLastLine(currentLine[0]);

    var previousLine = getPreviousLine(currentLine[0]);
    var nextLine = getNextLine(currentLine[0]);
    alertTxt = alertTxt + '\npreviousLine=' + previousLine[0] + ',' + previousLine[1];
    alertTxt = alertTxt + '\nnextLine=' + nextLine[0] + ',' + nextLine[1];

    var previousBlock = getPreviousBlock(currentLine[0]);
    alertTxt = alertTxt + '\nPreviousBlock=' + previousBlock[0] + ',' + previousBlock[1];

    var currentBlock = getCurrentBlock(currentLine[0]);
    alertTxt = alertTxt + '\nCurrentBlock=' + currentBlock[0] + ',' + currentBlock[1];

    var nextBlock = getNextBlock(currentLine[0]);
    alertTxt = alertTxt + '\nNextBlock=' + nextBlock[0] + ',' + nextBlock[1];

    alert(alertTxt);
}
    </script>
</head>

<body>
    <textarea id="textarea" style="width:100%; height:100%;font-family: monospace;"></textarea>
    <div id="console" hidden></div>
</body>
</html>
